<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMPEG RSUD dr. R. Koesma</title>
    <!-- Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        :root { --primary: #005A9C; --secondary: #004080; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f9; }
        
        /* Layout */
        .sidebar { min-height: 100vh; width: 260px; background: var(--primary); color: white; position: fixed; transition: all 0.3s; z-index: 1000; }
        .sidebar .nav-link { color: rgba(255,255,255,0.8); margin: 5px 15px; border-radius: 8px; font-weight: 500; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { background: rgba(255,255,255,0.15); color: white; transform: translateX(5px); }
        .sidebar .nav-link i { width: 25px; }
        .main-content { margin-left: 260px; padding: 25px; transition: all 0.3s; }
        
        /* Mobile */
        @media (max-width: 768px) {
            .sidebar { margin-left: -260px; }
            .sidebar.active { margin-left: 0; }
            .main-content { margin-left: 0; }
        }

        /* Components */
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .status-badge-DRAFT { background: #fff3cd; color: #856404; padding: 4px 10px; border-radius: 20px; font-size: 0.8em; font-weight: bold; border: 1px solid #ffeeba; }
        .status-badge-VERIFIED { background: #d4edda; color: #155724; padding: 4px 10px; border-radius: 20px; font-size: 0.8em; font-weight: bold; border: 1px solid #c3e6cb; }
        
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
        
        /* Admin specific */
        .admin-toolbar { position: sticky; top: 0; z-index: 900; background: white; padding: 15px; border-bottom: 1px solid #eee; margin: -1rem -1rem 1rem -1rem; display: flex; justify-content: space-between; align-items: center; }
        .table-admin th { background: #f8f9fa; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; }
    </style>
</head>
<body>

    <!-- LOADING -->
    <div id="loading" class="loading-overlay">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
        <h5 class="mt-3 text-primary fw-bold">Memproses Data...</h5>
    </div>

    <!-- 1. LOGIN SECTION -->
    <div id="app-login" class="container h-100 d-flex justify-content-center align-items-center" style="min-height: 100vh;">
        <div class="card p-4 shadow-lg" style="width: 100%; max-width: 400px;">
            <div class="text-center mb-4">
                <img src="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png" width="80" class="mb-3">
                <h4 class="fw-bold text-primary">SIMPEG RSUD</h4>
                <p class="text-muted small">Sistem Informasi Kepegawaian</p>
            </div>

            <!-- Tabs Login/Register -->
            <ul class="nav nav-pills nav-fill mb-3" id="pills-tab">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#login-tab">Login</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#reg-tab">Daftar</button></li>
            </ul>

            <div class="tab-content">
                <!-- FORM LOGIN -->
                <div class="tab-pane fade show active" id="login-tab">
                    <form onsubmit="handleLogin(event)">
                        <div class="mb-3"><input type="number" id="l-nik" class="form-control" placeholder="NIK" required></div>
                        <div class="mb-3"><input type="password" id="l-pass" class="form-control" placeholder="Password" required></div>
                        <button type="submit" class="btn btn-primary w-100 mb-3">Masuk</button>
                    </form>
                    <div class="text-center">
                        <small class="text-muted">Atau masuk dengan</small>
                        <div class="mt-2 d-flex justify-content-center">
                            <div id="g_id_onload" data-client_id="783459415718-mp0vsmd2lopajf2ut0aqc6drjrs95pu8.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_prompt="false"></div>
                            <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="outline" data-text="signin_with" data-size="large"></div>
                        </div>
                    </div>
                </div>

                <!-- FORM REGISTER -->
                <div class="tab-pane fade" id="reg-tab">
                    <form onsubmit="handleRegister(event)">
                        <div class="mb-3"><input type="number" id="r-nik" class="form-control" placeholder="NIK (KTP)" required minlength="16"></div>
                        <div class="mb-3"><input type="text" id="r-nama" class="form-control" placeholder="Nama Lengkap (Sesuai KTP)" required></div>
                        <div class="mb-3">
                            <input type="password" id="r-pass" class="form-control" placeholder="Password (Min 6 Karakter)" required minlength="6">
                            <small class="text-muted" style="font-size: 0.7em;">* Kombinasi Huruf & Angka</small>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Daftar Akun</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. MAIN APP SECTION -->
    <div id="app-main" class="d-none">
        
        <!-- Sidebar -->
        <div class="sidebar d-flex flex-column p-3" id="sidebar">
            <div class="text-center mb-4 text-white">
                <img src="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png" width="50" class="bg-white rounded-circle p-1 mb-2">
                <h6 class="fw-bold mb-0">SIMPEG RSUD</h6>
                <small id="user-display-name" class="text-white-50">User</small>
            </div>
            <ul class="nav flex-column mb-auto">
                <li class="nav-item"><a href="#" class="nav-link active" onclick="navTo('profil')"><i class="fas fa-user-circle"></i> Profil Pegawai</a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="navTo('pangkat')"><i class="fas fa-medal"></i> Riwayat Pangkat</a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="navTo('jabatan')"><i class="fas fa-briefcase"></i> Riwayat Jabatan</a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="navTo('keluarga')"><i class="fas fa-users"></i> Anggota Keluarga</a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="navTo('kartu')"><i class="fas fa-id-card"></i> Data Kartu</a></li>
                <li class="nav-item d-none" id="menu-admin"><a href="#" class="nav-link bg-danger text-white mt-3" onclick="navTo('admin')"><i class="fas fa-user-shield"></i> Admin Dashboard</a></li>
            </ul>
            <div class="mt-auto">
                <button onclick="logout()" class="btn btn-outline-light w-100"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>

        <!-- Content -->
        <div class="main-content" id="main-content">
            <!-- Mobile Toggle -->
            <button class="btn btn-primary d-md-none mb-3" onclick="document.getElementById('sidebar').classList.toggle('active')">
                <i class="fas fa-bars"></i> Menu
            </button>

            <!-- Dynamic Views -->
            <div id="view-container">
                <!-- Views will be injected here via JS -->
            </div>
        </div>
    </div>

    <!-- Javascript Logic -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ==========================================
        // CONFIG & STATE
        // ==========================================
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwgNdoZPiFJNdbM8tBmx1lGwonOj92sI8fgYUvEjR_x2Q-nwq9z_vkTq1MqMZG1MTAO/exec'; 
        let currentUser = null;
        let appData = {}; // Cache data user
        let adminData = {}; // Cache data admin (Pending lists)
        let selectedIds = []; // Untuk Bulk Verify

        // ==========================================
        // AUTH FUNCTIONS
        // ==========================================
        function toggleLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }

        async function handleLogin(e) {
            e.preventDefault();
            const nik = document.getElementById('l-nik').value;
            const pass = document.getElementById('l-pass').value;
            
            toggleLoading(true);
            const res = await fetchGAS({ action: 'login', nik, password: pass });
            toggleLoading(false);

            if (res.status === 'success') {
                loginSuccess(res.user);
            } else {
                Swal.fire('Gagal', res.message, 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const nik = document.getElementById('r-nik').value;
            const nama = document.getElementById('r-nama').value;
            const pass = document.getElementById('r-pass').value;
            
            if (!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,}$/.test(pass)) {
                Swal.fire('Password Lemah', 'Password harus minimal 6 karakter dan mengandung huruf serta angka.', 'warning');
                return;
            }

            toggleLoading(true);
            const res = await fetchGAS({ action: 'register', nik, nama, password: pass });
            toggleLoading(false);

            if (res.status === 'success') {
                Swal.fire('Berhasil', 'Akun dibuat. Silakan login.', 'success');
                document.querySelector('[data-bs-target="#login-tab"]').click();
            } else {
                Swal.fire('Gagal', res.message, 'error');
            }
        }

        function handleCredentialResponse(response) {
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            toggleLoading(true);
            fetchGAS({ action: 'google_login', email: payload.email }).then(res => {
                toggleLoading(false);
                if (res.status === 'success') loginSuccess(res.user);
                else Swal.fire('Akses Ditolak', res.message, 'error');
            });
        }

        function loginSuccess(user) {
            currentUser = user;
            sessionStorage.setItem('simpeg_user', JSON.stringify(user));
            if(window.location.hash === '#admin' && user.role !== 'ADMIN') {
                Swal.fire('Akses Ditolak', 'Anda bukan Admin.', 'warning');
                window.location.hash = '';
            }
            initApp();
        }

        function logout() {
            sessionStorage.removeItem('simpeg_user');
            window.location.reload();
        }

        // ==========================================
        // MAIN APP LOGIC
        // ==========================================
        async function initApp() {
            document.getElementById('app-login').classList.add('d-none');
            document.getElementById('app-main').classList.remove('d-none');
            document.getElementById('user-display-name').innerText = currentUser.nama;
            
            if (currentUser.role === 'ADMIN') document.getElementById('menu-admin').classList.remove('d-none');

            toggleLoading(true);
            const res = await fetchGAS({ action: 'get_data', nik: currentUser.nik });
            toggleLoading(false);

            if (res.status === 'success') {
                appData = res.data;
                if (window.location.hash === '#admin' && currentUser.role === 'ADMIN') navTo('admin');
                else navTo('profil');
            }
        }

        function navTo(page) {
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            const menu = document.querySelector(`[onclick="navTo('${page}')"]`);
            if(menu) menu.classList.add('active');

            const container = document.getElementById('view-container');
            
            if (page === 'profil') renderProfil(container);
            else if (page === 'pangkat') renderTable(container, 'Riwayat Pangkat', appData.tb_pangkat, 'tb_pangkat');
            else if (page === 'jabatan') renderTable(container, 'Riwayat Jabatan', appData.tb_jabatan, 'tb_jabatan');
            else if (page === 'keluarga') renderTable(container, 'Anggota Keluarga', appData.tb_keluarga, 'tb_keluarga');
            else if (page === 'kartu') renderTable(container, 'Data Kartu Identitas', appData.tb_kartu, 'tb_kartu');
            else if (page === 'admin') renderAdminDashboardV2(container);
        }

        // ==========================================
        // ADMIN DASHBOARD V2 (TABS & BULK VERIFY)
        // ==========================================
        function renderAdminDashboardV2(container) {
            container.innerHTML = `
                <div class="card p-4">
                    <h3 class="fw-bold mb-4 text-primary"><i class="fas fa-user-shield"></i> Admin Dashboard</h3>
                    
                    <ul class="nav nav-tabs mb-4" id="adminTabs">
                        <li class="nav-item"><button class="nav-link active fw-bold" data-bs-toggle="tab" data-bs-target="#tab-antrean" onclick="loadAdminAntrean()">Antrean Verifikasi</button></li>
                        <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#tab-master" onclick="loadAdminMaster()">Master Data Pegawai</button></li>
                        <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#tab-arsip" onclick="loadAdminArsip()">Arsip Data</button></li>
                    </ul>

                    <div class="tab-content">
                        <!-- TAB 1: ANTREAN -->
                        <div class="tab-pane fade show active" id="tab-antrean">
                            <div class="alert alert-info small"><i class="fas fa-info-circle"></i> Centang data untuk melakukan verifikasi massal.</div>
                            <div id="antrean-content" class="mt-3 text-center"><div class="spinner-border text-primary"></div></div>
                        </div>

                        <!-- TAB 2: MASTER PEGAWAI -->
                        <div class="tab-pane fade" id="tab-master">
                            <div class="d-flex justify-content-between mb-3">
                                <input type="text" id="search-master" class="form-control w-50" placeholder="Cari Nama / NIP..." onkeyup="filterMasterTable()">
                                <button class="btn btn-outline-primary" onclick="loadAdminMaster()"><i class="fas fa-sync"></i> Refresh</button>
                            </div>
                            <div id="master-content" class="table-responsive"></div>
                        </div>

                        <!-- TAB 3: ARSIP DATA -->
                        <div class="tab-pane fade" id="tab-arsip">
                            <div class="d-flex gap-3 mb-3 align-items-center">
                                <select id="arsip-type" class="form-select w-auto" onchange="loadAdminArsipTable()">
                                    <option value="tb_pangkat">Riwayat Pangkat</option>
                                    <option value="tb_jabatan">Riwayat Jabatan</option>
                                    <option value="tb_keluarga">Anggota Keluarga</option>
                                    <option value="tb_kartu">Kartu Identitas</option>
                                </select>
                                <button class="btn btn-primary" onclick="loadAdminArsipTable()">Muat Data</button>
                            </div>
                            <div id="arsip-content" class="table-responsive"></div>
                        </div>
                    </div>
                </div>
            `;
            loadAdminAntrean(); // Default load
        }

        // --- ADMIN LOGIC: ANTREAN (PENDING) ---
        async function loadAdminAntrean() {
            const content = document.getElementById('antrean-content');
            content.innerHTML = '<div class="spinner-border text-primary"></div>';
            
            const res = await fetchGAS({ action: 'admin_get_pending' });
            if(res.status === 'success') {
                adminData = res.data;
                renderAntreanTables(content);
            } else {
                content.innerHTML = `<div class="alert alert-danger">${res.message}</div>`;
            }
        }

        function renderAntreanTables(container) {
            let html = '';
            const tables = [
                { id: 'tb_profil', label: 'Update Profil' },
                { id: 'tb_pangkat', label: 'Riwayat Pangkat' },
                { id: 'tb_jabatan', label: 'Riwayat Jabatan' },
                { id: 'tb_keluarga', label: 'Data Keluarga' },
                { id: 'tb_kartu', label: 'Data Kartu' }
            ];

            let hasData = false;
            tables.forEach(t => {
                const list = adminData[t.id] || [];
                if(list.length > 0) {
                    hasData = true;
                    html += `
                        <div class="card mb-4 border shadow-sm">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 fw-bold text-primary">${t.label} (${list.length})</h6>
                                <button class="btn btn-sm btn-success" onclick="execBulkVerify('${t.id}')" id="btn-verify-${t.id}" disabled>
                                    <i class="fas fa-check-double"></i> Verifikasi Terpilih (0)
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover mb-0 align-middle table-admin">
                                    <thead>
                                        <tr>
                                            <th style="width: 40px;"><input type="checkbox" onchange="toggleSelectAll('${t.id}', this)"></th>
                                            <th>Identitas (NIK/Nama)</th>
                                            <th>Detail Data</th>
                                            <th>Dokumen</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    list.forEach(item => {
                        const itemId = item.ID || item.NIK; // Profil uses NIK as Key
                        const userIdent = `<b>${item.Nama || '-'}</b><br><span class="text-muted small">${item.NIK || item.NIK_Pegawai}</span>`;
                        const detail = `<small>${JSON.stringify(item).slice(0, 100)}...</small>`; // Simplifikasi view
                        const doc = item.Link_File ? `<a href="${item.Link_File}" target="_blank" class="btn btn-xs btn-outline-info"><i class="fas fa-file"></i></a>` : '-';
                        
                        html += `
                            <tr>
                                <td><input type="checkbox" class="cb-${t.id}" value="${itemId}" onchange="updateVerifyBtn('${t.id}')"></td>
                                <td>${userIdent}</td>
                                <td>${detail}</td>
                                <td>${doc}</td>
                            </tr>
                        `;
                    });
                    html += `</tbody></table></div></div>`;
                }
            });

            if(!hasData) html = `<div class="text-center py-5 text-muted"><i class="fas fa-check-circle fa-3x mb-3 text-success"></i><br>Tidak ada antrean verifikasi.</div>`;
            container.innerHTML = html;
        }

        function toggleSelectAll(tableId, source) {
            document.querySelectorAll(`.cb-${tableId}`).forEach(cb => cb.checked = source.checked);
            updateVerifyBtn(tableId);
        }

        function updateVerifyBtn(tableId) {
            const count = document.querySelectorAll(`.cb-${tableId}:checked`).length;
            const btn = document.getElementById(`btn-verify-${tableId}`);
            btn.innerHTML = `<i class="fas fa-check-double"></i> Verifikasi Terpilih (${count})`;
            btn.disabled = count === 0;
        }

        async function execBulkVerify(tableId) {
            const checkboxes = document.querySelectorAll(`.cb-${tableId}:checked`);
            const ids = Array.from(checkboxes).map(cb => cb.value);
            
            if(ids.length === 0) return;

            const confirm = await Swal.fire({
                title: 'Verifikasi Massal?',
                text: `Anda akan memverifikasi ${ids.length} data.`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Ya, Verifikasi'
            });

            if(confirm.isConfirmed) {
                toggleLoading(true);
                const res = await fetchGAS({ action: 'admin_bulk_verify', table: tableId, ids: ids });
                toggleLoading(false);
                
                if(res.status === 'success') {
                    Swal.fire('Sukses', res.message, 'success');
                    loadAdminAntrean(); // Refresh UI
                } else {
                    Swal.fire('Gagal', res.message, 'error');
                }
            }
        }

        // --- ADMIN LOGIC: MASTER DATA ---
        async function loadAdminMaster() {
            const container = document.getElementById('master-content');
            container.innerHTML = '<div class="spinner-border text-primary"></div>';
            
            const res = await fetchGAS({ action: 'admin_get_table', table: 'tb_profil' });
            if(res.status === 'success') {
                const data = res.data;
                let rows = '';
                data.forEach((p, idx) => {
                    const statusClass = p.Status_Verifikasi === 'VERIFIED' ? 'success' : 'warning';
                    rows += `
                        <tr class="master-row">
                            <td>${idx + 1}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="${p.Foto_Profil || 'https://via.placeholder.com/40'}" class="rounded-circle me-2" width="40" height="40">
                                    <div>
                                        <div class="fw-bold master-name">${p.Nama}</div>
                                        <div class="small text-muted master-nip">${p.NIP || p.NIK}</div>
                                    </div>
                                </div>
                            </td>
                            <td>${p.Jabatan_Terakhir || '-'}</td>
                            <td>${p.Unit_Kerja || '-'}</td>
                            <td><span class="badge bg-${statusClass}">${p.Status_Verifikasi}</span></td>
                        </tr>
                    `;
                });
                
                container.innerHTML = `
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr><th>No</th><th>Nama / NIP</th><th>Jabatan</th><th>Unit</th><th>Status</th></tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                `;
            }
        }

        function filterMasterTable() {
            const input = document.getElementById('search-master').value.toLowerCase();
            const rows = document.querySelectorAll('.master-row');
            rows.forEach(row => {
                const name = row.querySelector('.master-name').innerText.toLowerCase();
                const nip = row.querySelector('.master-nip').innerText.toLowerCase();
                if(name.includes(input) || nip.includes(input)) row.style.display = '';
                else row.style.display = 'none';
            });
        }

        // --- ADMIN LOGIC: ARSIP DATA ---
        async function loadAdminArsipTable() {
            const table = document.getElementById('arsip-type').value;
            const container = document.getElementById('arsip-content');
            container.innerHTML = '<div class="spinner-border text-primary m-3"></div>';
            
            const res = await fetchGAS({ action: 'admin_get_table', table: table });
            if(res.status === 'success') {
                const data = res.data;
                if(data.length === 0) {
                    container.innerHTML = '<div class="alert alert-warning m-3">Tidak ada data.</div>';
                    return;
                }
                
                // Dynamic Headers
                const headers = Object.keys(data[0]).filter(k => k !== 'ID' && k !== 'Link_File');
                let thead = '<tr><th>No</th>' + headers.map(h => `<th>${h}</th>`).join('') + '<th>File</th><th>Status</th></tr>';
                let tbody = '';
                
                data.forEach((row, idx) => {
                    let cells = headers.map(h => `<td>${row[h]}</td>`).join('');
                    let fileBtn = row.Link_File ? `<a href="${row.Link_File}" target="_blank" class="btn btn-sm btn-info"><i class="fas fa-file"></i></a>` : '-';
                    let statusBadge = `<span class="badge bg-${row.Status_Verifikasi==='VERIFIED'?'success':'warning'}">${row.Status_Verifikasi}</span>`;
                    tbody += `<tr><td>${idx+1}</td>${cells}<td>${fileBtn}</td><td>${statusBadge}</td></tr>`;
                });
                
                container.innerHTML = `<table class="table table-sm table-striped table-bordered mt-3"><thead class="table-dark">${thead}</thead><tbody>${tbody}</tbody></table>`;
            }
        }

        // ==========================================
        // USER VIEW RENDERERS (UNCHANGED logic)
        // ==========================================
        // ... (renderProfil, editProfil, renderTable, saveData, etc. tetap sama seperti sebelumnya) ...
        
        // 1. PROFIL VIEW
        function renderProfil(container) {
            const p = appData.profil || {};
            const statusBadge = `<span class="status-badge-${p.Status_Verifikasi || 'DRAFT'}">${p.Status_Verifikasi || 'DRAFT'}</span>`;
            
            container.innerHTML = `
                <div class="card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                        <h4 class="fw-bold text-primary mb-0">Profil Pegawai</h4>
                        <div>${statusBadge} <button onclick="editProfil()" class="btn btn-sm btn-primary ms-2"><i class="fas fa-edit"></i> Edit Data</button></div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 text-center mb-3">
                            <img src="${p.Foto_Profil || 'https://via.placeholder.com/150'}" class="img-thumbnail rounded-circle mb-2" style="width: 150px; height: 150px; object-fit: cover;">
                            <h5 class="fw-bold">${p.Nama}</h5>
                            <p class="text-muted">${p.NIP || '-'}</p>
                        </div>
                        <div class="col-md-9">
                            <div class="row g-3">
                                <div class="col-md-6"><label class="small text-muted">NIK</label><p class="fw-bold">${p.NIK}</p></div>
                                <div class="col-md-6"><label class="small text-muted">Tempat, Tgl Lahir</label><p class="fw-bold">${p.Tmp_Lahir || '-'}, ${p.Tgl_Lahir || '-'}</p></div>
                                <div class="col-md-6"><label class="small text-muted">Jenis Kelamin</label><p class="fw-bold">${p.JK || '-'}</p></div>
                                <div class="col-md-6"><label class="small text-muted">Agama</label><p class="fw-bold">${p.Agama || '-'}</p></div>
                                <div class="col-md-6"><label class="small text-muted">No HP</label><p class="fw-bold">${p.No_HP || '-'}</p></div>
                                <div class="col-md-6"><label class="small text-muted">Email</label><p class="fw-bold">${p.Email || '-'}</p></div>
                                <div class="col-md-12"><label class="small text-muted">Alamat Domisili</label><p class="fw-bold">${p.Alamat || '-'}</p></div>
                                <div class="col-md-6"><label class="small text-muted">Pendidikan Terakhir</label><p class="fw-bold">${p.Pendidikan || '-'}</p></div>
                                <div class="col-md-6"><label class="small text-muted">Jabatan Terakhir</label><p class="fw-bold">${p.Jabatan_Terakhir || '-'}</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function editProfil() {
            const p = appData.profil || {};
            const { value: formValues } = await Swal.fire({
                title: 'Edit Profil',
                html: `
                    <input id="sw-nip" class="swal2-input" placeholder="NIP" value="${p.NIP||''}">
                    <input id="sw-nama" class="swal2-input" placeholder="Nama Lengkap" value="${p.Nama||''}">
                    <div class="d-flex gap-2 mx-5 mt-3">
                        <input id="sw-tmp" class="form-control" placeholder="Tempat Lahir" value="${p.Tmp_Lahir||''}">
                        <input id="sw-tgl" class="form-control" type="date" value="${p.Tgl_Lahir||''}">
                    </div>
                    <select id="sw-jk" class="swal2-select" style="width:80%; margin: 10px auto; display:block;">
                        <option value="L" ${p.JK=='L'?'selected':''}>Laki-laki</option>
                        <option value="P" ${p.JK=='P'?'selected':''}>Perempuan</option>
                    </select>
                    <input id="sw-hp" class="swal2-input" placeholder="Nomor HP" value="${p.No_HP||''}">
                    <input id="sw-alamat" class="swal2-input" placeholder="Alamat Domisili" value="${p.Alamat||''}">
                    <input id="sw-pend" class="swal2-input" placeholder="Pendidikan Terakhir" value="${p.Pendidikan||''}">
                    <input id="sw-jab" class="swal2-input" placeholder="Jabatan Terakhir" value="${p.Jabatan_Terakhir||''}">
                    <div class="mx-5 mt-3 text-start"><label class="small">Upload Foto Profil Baru</label><input type="file" id="sw-foto" class="form-control"></div>
                `,
                width: '600px',
                showCancelButton: true,
                confirmButtonText: 'Simpan',
                preConfirm: async () => {
                    const fileInput = document.getElementById('sw-foto').files[0];
                    let fotoUrl = p.Foto_Profil;
                    
                    if (fileInput) {
                        const base64 = await toBase64(fileInput);
                        const upRes = await fetchGAS({ action: 'upload_file', base64: base64.split(',')[1], mimeType: fileInput.type, nik: currentUser.nik, type: 'FOTO' });
                        if(upRes.status === 'success') fotoUrl = upRes.url;
                    }

                    return {
                        NIP: document.getElementById('sw-nip').value,
                        Nama: document.getElementById('sw-nama').value,
                        Tmp_Lahir: document.getElementById('sw-tmp').value,
                        Tgl_Lahir: document.getElementById('sw-tgl').value,
                        JK: document.getElementById('sw-jk').value,
                        No_HP: document.getElementById('sw-hp').value,
                        Alamat: document.getElementById('sw-alamat').value,
                        Pendidikan: document.getElementById('sw-pend').value,
                        Jabatan_Terakhir: document.getElementById('sw-jab').value,
                        Foto_Profil: fotoUrl
                    };
                }
            });

            if (formValues) {
                saveData('tb_profil', formValues);
            }
        }

        function renderTable(container, title, data, tableName) {
            let rows = '';
            if (data && data.length > 0) {
                data.forEach((item, index) => {
                    const badge = `<span class="status-badge-${item.Status_Verifikasi}">${item.Status_Verifikasi}</span>`;
                    let info = '';
                    if (tableName === 'tb_pangkat') info = `<b>${item.Pangkat} (${item.Golongan})</b><br>SK: ${item.No_SK} (${item.Tgl_SK})`;
                    else if (tableName === 'tb_jabatan') info = `<b>${item.Nama_Jabatan}</b><br>${item.Unit_Kerja}`;
                    else if (tableName === 'tb_keluarga') info = `<b>${item.Nama}</b> (${item.Hubungan})<br>JK: ${item.JK}, Tgl Lahir: ${item.Tgl_Lahir}`;
                    else info = `<b>${item.Jenis_Kartu}</b><br>${item.No_Kartu}`;

                    const btnFile = item.Link_File ? `<a href="${item.Link_File}" target="_blank" class="btn btn-sm btn-info me-1"><i class="fas fa-file"></i></a>` : '';

                    rows += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${info}</td>
                            <td>${item.TMT || item.Tunjangan || '-'}</td>
                            <td>${badge}</td>
                            <td>
                                ${btnFile}
                                <button onclick="editData('${tableName}', '${item.ID}')" class="btn btn-sm btn-warning"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteData('${tableName}', '${item.ID}')" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
            } else {
                rows = '<tr><td colspan="5" class="text-center p-4">Belum ada data.</td></tr>';
            }

            container.innerHTML = `
                <div class="card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="fw-bold text-primary mb-0">${title}</h4>
                        <button onclick="addData('${tableName}')" class="btn btn-primary"><i class="fas fa-plus"></i> Tambah Data</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr><th>No</th><th>Detail Data</th><th>Ket (TMT/Tunjangan)</th><th>Status</th><th>Aksi</th></tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        async function saveData(tableName, values, id = null) {
            toggleLoading(true);
            const payload = { action: 'save_data', table: tableName, values: values, nik: currentUser.nik };
            if (id) payload.values.ID = id;
            const res = await fetchGAS(payload);
            if (res.status === 'success') {
                const refresh = await fetchGAS({ action: 'get_data', nik: currentUser.nik });
                if (refresh.status === 'success') appData = refresh.data;
                toggleLoading(false);
                Swal.fire('Berhasil', 'Data disimpan (Menunggu Verifikasi)', 'success').then(() => {
                    if(tableName === 'tb_profil') navTo('profil');
                    else if(tableName === 'tb_pangkat') navTo('pangkat');
                    else if(tableName === 'tb_jabatan') navTo('jabatan');
                    else if(tableName === 'tb_keluarga') navTo('keluarga');
                    else if(tableName === 'tb_kartu') navTo('kartu');
                });
            } else {
                toggleLoading(false);
                Swal.fire('Error', res.message, 'error');
            }
        }

        function deleteData(tableName, id) {
            Swal.fire({
                title: 'Hapus Data?', text: "Data tidak bisa dikembalikan!", icon: 'warning',
                showCancelButton: true, confirmButtonText: 'Ya, Hapus'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    toggleLoading(true);
                    await fetchGAS({ action: 'delete_data', table: tableName, id: id });
                    const refresh = await fetchGAS({ action: 'get_data', nik: currentUser.nik });
                    appData = refresh.data;
                    toggleLoading(false);
                    Swal.fire('Terhapus', 'Data berhasil dihapus.', 'success');
                    const activeNav = document.querySelector('.nav-link.active');
                    if(activeNav) activeNav.click();
                }
            });
        }

        async function addData(tableName) {
            let htmlForm = '';
            if (tableName === 'tb_pangkat') {
                htmlForm = `
                    <input id="f-gol" class="swal2-input" placeholder="Golongan (ex: III/a)">
                    <input id="f-pangkat" class="swal2-input" placeholder="Nama Pangkat">
                    <input id="f-nosk" class="swal2-input" placeholder="Nomor SK">
                    <label>Tgl SK</label><input type="date" id="f-tglsk" class="swal2-input">
                    <label>TMT</label><input type="date" id="f-tmt" class="swal2-input">
                    <div class="mt-3"><label>Upload SK (PDF/Img)</label><input type="file" id="f-file" class="form-control"></div>
                `;
            } else if (tableName === 'tb_keluarga') {
                htmlForm = `
                    <input id="f-nama" class="swal2-input" placeholder="Nama Anggota Keluarga">
                    <input id="f-nik" class="swal2-input" placeholder="NIK Anggota">
                    <select id="f-hub" class="swal2-select"><option>Suami</option><option>Istri</option><option>Anak</option></select>
                    <select id="f-jk" class="swal2-select"><option value="L">L</option><option value="P">P</option></select>
                    <label>Tgl Lahir</label><input type="date" id="f-tgl" class="swal2-input">
                    <select id="f-tunj" class="swal2-select"><option value="Ya">Dapat Tunjangan</option><option value="Tidak">Tidak</option></select>
                `;
            } else if (tableName === 'tb_jabatan') {
                htmlForm = `
                    <input id="f-nama" class="swal2-input" placeholder="Nama Jabatan">
                    <select id="f-jenis" class="swal2-select"><option>Struktural</option><option>Fungsional</option><option>Pelaksana</option></select>
                    <input id="f-eselon" class="swal2-input" placeholder="Eselon (Opsional)">
                    <input id="f-unit" class="swal2-input" placeholder="Unit Kerja">
                    <input id="f-nosk" class="swal2-input" placeholder="Nomor SK">
                    <label>TMT</label><input type="date" id="f-tmt" class="swal2-input">
                    <div class="mt-3"><label>Upload SK</label><input type="file" id="f-file" class="form-control"></div>
                `;
            } else if (tableName === 'tb_kartu') {
                htmlForm = `
                    <select id="f-jenis" class="swal2-select"><option>BPJS</option><option>NPWP</option><option>Karpeg</option><option>Taspen</option></select>
                    <input id="f-nomor" class="swal2-input" placeholder="Nomor Kartu">
                    <div class="mt-3"><label>Upload Foto Kartu</label><input type="file" id="f-file" class="form-control"></div>
                `;
            }

            const { value: formValues } = await Swal.fire({
                title: 'Tambah Data',
                html: htmlForm || '<p>Form belum didefinisikan.</p>',
                showCancelButton: true,
                preConfirm: async () => {
                    if (!htmlForm) return null;
                    let fileUrl = '';
                    const fileInput = document.getElementById('f-file');
                    if (fileInput && fileInput.files[0]) {
                        const base64 = await toBase64(fileInput.files[0]);
                        const upRes = await fetchGAS({ action: 'upload_file', base64: base64.split(',')[1], mimeType: fileInput.files[0].type, nik: currentUser.nik, type: 'DOC' });
                        if (upRes.status === 'success') fileUrl = upRes.url;
                    }

                    if (tableName === 'tb_pangkat') return { Golongan: document.getElementById('f-gol').value, Pangkat: document.getElementById('f-pangkat').value, No_SK: document.getElementById('f-nosk').value, Tgl_SK: document.getElementById('f-tglsk').value, TMT: document.getElementById('f-tmt').value, Link_File: fileUrl };
                    else if (tableName === 'tb_keluarga') return { Nama: document.getElementById('f-nama').value, NIK_Anggota: document.getElementById('f-nik').value, Hubungan: document.getElementById('f-hub').value, JK: document.getElementById('f-jk').value, Tgl_Lahir: document.getElementById('f-tgl').value, Tunjangan: document.getElementById('f-tunj').value };
                    else if (tableName === 'tb_jabatan') return { Nama_Jabatan: document.getElementById('f-nama').value, Jenis_Jabatan: document.getElementById('f-jenis').value, Eselon: document.getElementById('f-eselon').value, Unit_Kerja: document.getElementById('f-unit').value, No_SK: document.getElementById('f-nosk').value, TMT: document.getElementById('f-tmt').value, Link_File: fileUrl };
                    else if (tableName === 'tb_kartu') return { Jenis_Kartu: document.getElementById('f-jenis').value, No_Kartu: document.getElementById('f-nomor').value, Link_File: fileUrl };
                    
                    return {};
                }
            });

            if (formValues) saveData(tableName, formValues);
        }

        // ==========================================
        // UTILS
        // ==========================================
        async function fetchGAS(payload) {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            return await response.json();
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // INIT CHECK
        const sessUser = sessionStorage.getItem('simpeg_user');
        if (sessUser) {
            currentUser = JSON.parse(sessUser);
            initApp();
        }
    </script>
</body>
</html>
