<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMPEG RSUD dr. R. Koesma</title>
    <!-- Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        /* --- THEME CONFIGURATION: ORANGE GLASS BATIK --- */
        :root { 
            /* Orange / Terracotta Palette */
            --primary: #c2410c;       /* Orange 700 */
            --primary-dark: #7c2d12;  /* Orange 900 */
            --primary-light: #fb923c; /* Orange 400 */
            --accent: #ffedd5;        /* Orange 100 */
            
            /* Glassmorphism Variables */
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: 1px solid rgba(255, 255, 255, 0.3);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            --text-on-glass: #ffffff;
            --text-muted-on-glass: #fdba74; /* Orange 300 */
        }
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background: #fff7ed; /* Very light orange fallback */
            color: #333;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        
        /* --- SIDEBAR (PC & MOBILE FIXED) --- */
        .sidebar { 
            min-height: 100vh; 
            width: 250px; /* Lebar Sidebar */
            background: linear-gradient(180deg, var(--primary-dark) 0%, var(--primary) 100%);
            color: white; 
            position: fixed; 
            top: 0;
            left: 0; /* Default Muncul di PC */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            z-index: 1050; 
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
        }

        /* State Collapsed (Disembunyikan di PC) */
        .sidebar.collapsed { 
            left: -250px; 
        } 

        .sidebar .nav-link { 
            color: rgba(255,255,255,0.85); 
            margin: 4px 12px; 
            padding: 10px 15px;
            border-radius: 8px; 
            font-weight: 500; 
            font-size: 0.85rem; /* Font diperkecil agar 1 baris */
            white-space: nowrap; /* Mencegah turun baris */
            cursor: pointer; 
            position: relative; 
            z-index: 1051;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
        }

        .sidebar .nav-link:hover, .sidebar .nav-link.active { 
            background: rgba(255, 255, 255, 0.2); 
            color: #fff; 
            transform: translateX(3px); 
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .sidebar .nav-link i { width: 22px; font-size: 1rem; margin-right: 8px; }
        
        /* --- MAIN CONTENT --- */
        .main-content { 
            margin-left: 250px; /* Default margin selebar sidebar */
            padding: 25px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            min-height: 100vh;
        }

        /* Saat Sidebar Collapsed, Main Content Melebar */
        .main-content.expanded { 
            margin-left: 0; 
        }
        
        /* --- MOBILE OVERRIDES --- */
        .sidebar-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); z-index: 1040;
            transition: opacity 0.3s;
        }
        .sidebar-overlay.active { display: block; }

        @media (max-width: 768px) {
            /* Di Mobile, default sidebar sembunyi (left -250) */
            .sidebar { left: -250px; } 
            
            /* Di Mobile, saat active dia muncul (left 0) */
            .sidebar.active { left: 0; } 
            
            /* Di Mobile, margin content selalu 0 */
            .main-content { margin-left: 0; }
            .main-content.expanded { margin-left: 0; }
        }

        /* --- SWEETALERT2 ORANGE THEME --- */
        .swal2-popup { font-size: 0.9rem !important; border-radius: 16px !important; padding: 1.5em !important; border-top: 5px solid var(--primary); }
        .swal2-title { font-size: 1.3rem !important; font-weight: 700 !important; color: var(--primary-dark) !important; }
        .swal2-confirm { background-color: var(--primary) !important; box-shadow: 0 4px 10px rgba(194, 65, 12, 0.3) !important; }
        .swal-form-group { text-align: left; margin-bottom: 0.8rem; }
        .swal-form-label { font-weight: 600; font-size: 0.8rem; margin-bottom: 0.3rem; display: block; color: var(--primary-dark); }
        
        /* --- COMPONENTS --- */
        .card { border: none; border-radius: 16px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); transition: transform 0.2s; background: #fff; }
        
        /* Badges */
        .status-badge-DRAFT { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; padding: 4px 10px; border-radius: 20px; font-size: 0.75em; font-weight: 700; }
        .status-badge-VERIFIED { background: #ecfdf5; color: #047857; border: 1px solid #d1fae5; padding: 4px 10px; border-radius: 20px; font-size: 0.75em; font-weight: 700; }
        
        /* Loading */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.85); backdrop-filter: blur(5px); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .spinner-border { color: var(--primary); }

        /* Tables */
        .table-admin th { background-color: #fff7ed; color: var(--primary-dark); font-size: 0.8rem; text-transform: uppercase; font-weight: 700; border-bottom: 2px solid var(--primary-light); }
        .table-admin td { font-size: 0.85rem; }

        /* Tabs */
        .nav-tabs .nav-link { cursor: pointer; color: #78716c; font-weight: 500; border: none; background: transparent; transition: 0.2s; }
        .nav-tabs .nav-link:hover { color: var(--primary); }
        .nav-tabs .nav-link.active { color: var(--primary); font-weight: 700; border-bottom: 3px solid var(--primary); background: transparent; }

        /* --- LOGIN STYLING (ORANGE GLASS BATIK) --- */
        .login-wrapper { 
            min-height: 100vh; 
            background-color: var(--primary-dark);
            background-image: 
                linear-gradient(135deg, rgba(124, 45, 18, 0.9) 0%, rgba(251, 146, 60, 0.85) 100%),
                url("https://www.transparenttextures.com/patterns/batik.png"); 
            background-size: cover;
            background-blend-mode: multiply;
            display: flex; align-items: center; justify-content: center; padding: 20px; 
        }

        .login-card-modern { 
            background: var(--glass-bg);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: var(--glass-border); box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            border-radius: 24px; width: 100%; max-width: 400px; padding: 40px; 
            position: relative; overflow: hidden; color: var(--text-on-glass);
        }
        
        .login-card-modern::before { 
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px; 
            background: linear-gradient(90deg, #fb923c, #c2410c); 
        }

        .login-header { text-align: center; margin-bottom: 30px; }
        .login-header img { width: 80px; margin-bottom: 15px; border: 2px solid rgba(255,255,255,0.4); border-radius: 50%; padding: 5px; background: rgba(255,255,255,0.15); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .login-header h4 { font-weight: 700; color: #fff; letter-spacing: 0.5px; margin-bottom: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .login-header p { color: var(--text-muted-on-glass); font-size: 0.85rem; font-weight: 300; }
        
        .form-modern .form-label { font-size: 0.8rem; font-weight: 600; color: #fff7ed; margin-left: 2px; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .form-modern .form-control { 
            padding: 10px 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.4); 
            background-color: rgba(255, 255, 255, 0.95); font-size: 0.9rem; color: #7c2d12;
            transition: all 0.3s;
        }
        .form-modern .form-control:focus { background-color: #fff; border-color: #fb923c; box-shadow: 0 0 0 3px rgba(251, 146, 60, 0.3); outline: none; }
        
        .btn-primary-modern { 
            background: linear-gradient(135deg, #fb923c, #c2410c); 
            border: none; color: white; padding: 12px; border-radius: 10px; 
            font-weight: 600; letter-spacing: 0.5px; width: 100%; margin-top: 15px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: all 0.2s;
        }
        .btn-primary-modern:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(124, 45, 18, 0.3); color: white; }
        
        .auth-separator { display: flex; align-items: center; text-align: center; color: rgba(255,255,255,0.6); margin: 20px 0; font-size: 0.7rem; font-weight: 500; }
        .auth-separator::before, .auth-separator::after { content: ''; flex: 1; border-bottom: 1px solid rgba(255,255,255,0.3); }
        .auth-footer { text-align: center; margin-top: 20px; font-size: 0.85rem; color: var(--text-muted-on-glass); }
        .auth-footer a { color: #fff; font-weight: 700; text-decoration: none; border-bottom: 1px dashed rgba(255,255,255,0.6); }
        .auth-footer a:hover { color: #fb923c; border-bottom-color: #fb923c; }

        .animate-fade { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div class="spinner-border" style="width: 3rem; height: 3rem;"></div>
        <h5 class="mt-3 text-secondary fw-bold">Memproses Data...</h5>
    </div>

    <!-- LOGIN SECTION -->
    <div id="app-login" class="login-wrapper">
        <div class="login-card-modern animate-fade">
            <div class="login-header">
                <img src="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png" alt="Logo RSUD">
                <h4>SIMPEG RSUD</h4>
                <p>RSUD dr. R. Koesma Tuban</p>
            </div>

            <!-- LOGIN -->
            <div id="view-auth-login">
                <form onsubmit="handleLogin(event)" class="form-modern">
                    <div class="mb-3">
                        <label class="form-label">NIK atau Email</label>
                        <input type="text" id="l-identifier" class="form-control" placeholder="NIK / Email" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Kata Sandi</label>
                        <div class="position-relative">
                            <input type="password" id="l-pass" class="form-control" placeholder="••••••••" required style="padding-right: 40px;">
                            <span class="position-absolute top-50 end-0 translate-middle-y me-3" onclick="togglePassword('l-pass', this)" style="cursor: pointer; color: var(--primary);">
                                <i class="fas fa-eye"></i>
                            </span>
                        </div>
                    </div>
                    <div class="text-end mb-4"><a href="#" onclick="forgotPassword()" class="text-decoration-none small text-white opacity-75">Lupa Password?</a></div>
                    <button type="submit" class="btn-primary-modern">MASUK</button>
                </form>
                <div class="auth-separator"><span>ATAU</span></div>
                <div class="d-flex justify-content-center">
                    <div id="g_id_onload" data-client_id="783459415718-mp0vsmd2lopajf2ut0aqc6drjrs95pu8.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_prompt="false"></div>
                    <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="outline" data-text="signin_with" data-size="large" data-logo_alignment="left" data-width="310"></div>
                </div>
                <div class="auth-footer">Belum punya akun? <a onclick="switchAuthMode('register')">Daftar</a></div>
            </div>

            <!-- REGISTER -->
            <div id="view-auth-register" class="d-none">
                <form onsubmit="handleRegister(event)" class="form-modern">
                    <div class="mb-3"><label class="form-label">NIK (Sesuai KTP)</label><input type="number" id="r-nik" class="form-control" placeholder="16 Digit" required minlength="16"></div>
                    <div class="mb-3"><label class="form-label">Nama Lengkap</label><input type="text" id="r-nama" class="form-control" required></div>
                    <div class="mb-3"><label class="form-label">Email (Wajib)</label><input type="email" id="r-email" class="form-control" required></div>
                    <div class="mb-4">
                        <label class="form-label">Buat Sandi</label>
                        <div class="position-relative">
                            <input type="password" id="r-pass" class="form-control" required minlength="6" style="padding-right: 40px;">
                            <span class="position-absolute top-50 end-0 translate-middle-y me-3" onclick="togglePassword('r-pass', this)" style="cursor: pointer; color: var(--primary);">
                                <i class="fas fa-eye"></i>
                            </span>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary-modern">DAFTAR</button>
                </form>
                <div class="auth-footer">Sudah punya akun? <a onclick="switchAuthMode('login')">Masuk</a></div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-main" class="d-none">
        
        <!-- Overlay -->
        <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <div class="sidebar d-flex flex-column p-3" id="sidebar">
            <div class="d-flex justify-content-between align-items-center mb-4 text-white">
                <div class="text-center w-100">
                    <img src="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png" width="45" class="bg-white rounded-circle p-1 mb-2 shadow-sm">
                    <h6 class="fw-bold mb-0 text-white" style="letter-spacing: 1px;">SIMPEG</h6>
                    <small id="user-display-name" class="text-white-50" style="font-size: 0.75rem;">User</small>
                </div>
                <!-- Mobile Close -->
                <button class="btn btn-sm text-white d-md-none position-absolute top-0 end-0 m-2" onclick="toggleSidebar()">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            
            <ul class="nav flex-column mb-auto">
                <li class="nav-item"><a class="nav-link active" onclick="navTo('profil')"><i class="fas fa-user-circle me-2"></i> Profil Pegawai</a></li>
                <li class="nav-item"><a class="nav-link" onclick="navTo('pangkat')"><i class="fas fa-medal me-2"></i> Riwayat Pangkat</a></li>
                <li class="nav-item"><a class="nav-link" onclick="navTo('jabatan')"><i class="fas fa-briefcase me-2"></i> Riwayat Jabatan</a></li>
                <li class="nav-item"><a class="nav-link" onclick="navTo('keluarga')"><i class="fas fa-users me-2"></i> Keluarga</a></li>
                <li class="nav-item"><a class="nav-link" onclick="navTo('kartu')"><i class="fas fa-id-card me-2"></i> Data Kartu</a></li>
                <li class="nav-item d-none" id="menu-admin"><a class="nav-link bg-white text-danger mt-3 shadow-sm" onclick="navTo('admin')" style="color: var(--primary) !important;"><i class="fas fa-user-shield me-2"></i> Admin Panel</a></li>
            </ul>
            <div class="mt-auto"><button onclick="logout()" class="btn btn-outline-light w-100 btn-sm"><i class="fas fa-sign-out-alt me-2"></i> Logout</button></div>
        </div>

        <!-- Content -->
        <div class="main-content" id="main-content">
            <!-- Toggle Button (Visible on both PC & Mobile) -->
            <button class="btn btn-light shadow-sm text-primary mb-3 border" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i> Menu
            </button>
            <div id="view-container"></div>
        </div>
    </div>

    <!-- Script -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwgNdoZPiFJNdbM8tBmx1lGwonOj92sI8fgYUvEjR_x2Q-nwq9z_vkTq1MqMZG1MTAO/exec'; 
        let currentUser = null, appData = {}, adminData = {}, selectedIds = []; 

        function toggleLoading(s) { document.getElementById('loading').style.display = s ? 'flex' : 'none'; }
        
        // [FIXED] Sidebar Toggle Logic for PC & Mobile
        function toggleSidebar() { 
            const s = document.getElementById('sidebar');
            const o = document.getElementById('sidebar-overlay');
            const m = document.getElementById('main-content');
            
            if (window.innerWidth > 768) {
                // PC: Toggle Collapse class
                s.classList.toggle('collapsed');
                m.classList.toggle('expanded');
            } else {
                // Mobile: Toggle Active class
                s.classList.toggle('active');
                o.classList.toggle('active');
            }
        }

        function togglePassword(id, t) { const i=document.getElementById(id), c=t.querySelector('i'); if(i.type==='password'){i.type='text';c.classList.replace('fa-eye','fa-eye-slash')}else{i.type='password';c.classList.replace('fa-eye-slash','fa-eye')} }
        function getImgUrl(u) { if(!u||u.length<5)return 'https://via.placeholder.com/150';if(u.includes('drive.google.com'))try{return `https://lh3.googleusercontent.com/d/${u.split('/d/')[1].split('/')[0]}`}catch(e){return u}return u;}
        function toBase64(f) { return new Promise((r,j)=>{const d=new FileReader();d.readAsDataURL(f);d.onload=()=>r(d.result);d.onerror=e=>j(e)})}
        function formatDateDisplay(d) { if(!d)return'-';const dt=new Date(d);if(isNaN(dt.getTime()))return d;return `${String(dt.getDate()).padStart(2,'0')}-${String(dt.getMonth()+1).padStart(2,'0')}-${dt.getFullYear()}`}
        function switchAuthMode(m) { const l=document.getElementById('view-auth-login'),r=document.getElementById('view-auth-register');if(m==='register'){l.classList.add('d-none');r.classList.remove('d-none');r.classList.add('animate-fade')}else{r.classList.add('d-none');l.classList.remove('d-none');l.classList.add('animate-fade')} }

        // API Calls
        async function handleLogin(e) { e.preventDefault();toggleLoading(true);const r=await fetchGAS({action:'login',identifier:document.getElementById('l-identifier').value,password:document.getElementById('l-pass').value});toggleLoading(false);if(r.status==='success')loginSuccess(r.user);else Swal.fire('Gagal',r.message,'error')}
        async function handleRegister(e) { e.preventDefault();const p=document.getElementById('r-pass').value;if(p.length<6){Swal.fire('Warning','Sandi min 6 karakter','warning');return}toggleLoading(true);const r=await fetchGAS({action:'register',nik:document.getElementById('r-nik').value,nama:document.getElementById('r-nama').value,email:document.getElementById('r-email').value,password:p});toggleLoading(false);if(r.status==='success'){Swal.fire('Sukses','Akun dibuat','success');switchAuthMode('login')}else Swal.fire('Gagal',r.message,'error')}
        function handleCredentialResponse(r) { const p=JSON.parse(atob(r.credential.split('.')[1]));toggleLoading(true);fetchGAS({action:'google_login',email:p.email}).then(res=>{toggleLoading(false);if(res.status==='success')loginSuccess(res.user);else Swal.fire('Gagal',res.message,'error')})}
        async function forgotPassword() { const {value:v}=await Swal.fire({title:'Reset Password',input:'text',inputPlaceholder:'NIK/Email',showCancelButton:true});if(v){const r=await fetchGAS({action:'forgot_password',identifier:v});Swal.fire(r.status==='success'?'Terkirim':'Gagal',r.message,r.status==='success'?'success':'error')}}
        async function changePassword() { const {value:v}=await Swal.fire({title:'Ubah Sandi',html:'<input type="password" id="old" class="swal2-input" placeholder="Lama"><input type="password" id="new" class="swal2-input" placeholder="Baru">',showCancelButton:true,preConfirm:async()=>{const o=document.getElementById('old').value,n=document.getElementById('new').value;if(!o||!n)return Swal.showValidationMessage('Isi semua');try{const r=await fetchGAS({action:'change_password',nik:currentUser.nik,oldPass:o,newPass:n});if(r.status!=='success')throw new Error(r.message);return r.message}catch(e){Swal.showValidationMessage(e.message)}}});if(v)Swal.fire('Sukses',v,'success')}

        function loginSuccess(u) { currentUser=u;sessionStorage.setItem('simpeg_user',JSON.stringify(u));initApp()}
        function logout() { sessionStorage.removeItem('simpeg_user');window.location.reload()}
        async function initApp() { 
            document.getElementById('app-login').classList.add('d-none'); document.getElementById('app-main').classList.remove('d-none'); 
            document.getElementById('user-display-name').innerText=currentUser.nama; 
            if(currentUser.role==='ADMIN')document.getElementById('menu-admin').classList.remove('d-none');
            toggleLoading(true); const r=await fetchGAS({action:'get_data',nik:currentUser.nik}); toggleLoading(false);
            if(r.status==='success'){ appData=r.data; processCurrentHash(); }
        }

        // Routing
        function processCurrentHash() { let h=window.location.hash.substring(1)||'profil'; if(h==='riwayatjabatan')h='jabatan'; if(h==='riwayatpangkat')h='pangkat'; if(h==='anggotakeluarga')h='keluarga'; if(h==='datakartu')h='kartu'; if(h==='admin'&&currentUser.role!=='ADMIN')h='profil'; renderPage(h); }
        window.addEventListener('hashchange', processCurrentHash);
        function navTo(p) { 
            if(window.innerWidth<=768){document.getElementById('sidebar').classList.remove('active');document.getElementById('sidebar-overlay').classList.remove('active')}
            let h=p; if(p==='jabatan')h='riwayatjabatan'; if(p==='pangkat')h='riwayatpangkat'; if(p==='keluarga')h='anggotakeluarga'; if(p==='kartu')h='datakartu'; 
            window.location.hash=h; 
        }
        function renderPage(p) {
            document.querySelectorAll('.nav-link').forEach(e=>e.classList.remove('active'));
            let k=p; if(p==='pangkat')k='pangkat'; if(p==='jabatan')k='jabatan';
            const m=document.querySelector(`[onclick="navTo('${k}')"]`); if(m)m.classList.add('active');
            const c=document.getElementById('view-container');
            if(p==='profil')renderProfil(c); else if(p==='admin')renderAdminDashboardV2(c); else renderTable(c,p,`tb_${p}`);
        }

        function renderProfil(c) {
            const p=appData.profil||{}, url=getImgUrl(p.Foto_Profil); const l=currentUser.email_login?.toLowerCase().trim(), pe=p.Email?.toLowerCase().trim();
            const en=(pe&&l&&pe===l)?'<span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25" style="font-size:0.7em">Login OK</span>':'<span class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25" style="font-size:0.7em">Kontak Saja</span>';
            c.innerHTML=`<div class="card p-4"><div class="d-flex justify-content-between mb-4 border-bottom pb-3"><h4 class="fw-bold text-primary mb-0">Profil</h4><div><span class="badge bg-${p.Status_Verifikasi==='VERIFIED'?'success':'warning'}">${p.Status_Verifikasi||'DRAFT'}</span><button onclick="editProfil()" class="btn btn-sm btn-primary ms-1"><i class="fas fa-edit"></i> Edit</button><button onclick="changePassword()" class="btn btn-sm btn-warning ms-1"><i class="fas fa-key"></i> Pass</button></div></div><div class="row"><div class="col-md-3 text-center mb-3"><img src="${url}" class="img-thumbnail rounded-circle mb-2" style="width:120px;height:120px;object-fit:cover"><h5 class="fw-bold">${p.Nama||'User'}</h5><p class="text-muted small">${p.NIP||'-'}</p></div><div class="col-md-9"><div class="row g-3"><div class="col-md-6"><label class="small text-muted">NIK</label><p class="fw-bold small">${p.NIK||'-'}</p></div><div class="col-md-6"><label class="small text-muted">NIP</label><p class="fw-bold small">${p.NIP||'-'}</p></div><div class="col-md-6"><label class="small text-muted">Tgl Lahir</label><p class="fw-bold small">${p.Tmp_Lahir||''}, ${formatDateDisplay(p.Tgl_Lahir)}</p></div><div class="col-md-6"><label class="small text-muted">Email</label><p class="fw-bold small mb-1">${p.Email||'-'}</p>${en}</div><div class="col-md-6"><label class="small text-muted">Pendidikan</label><p class="fw-bold small">${p.Pendidikan||'-'}</p></div><div class="col-md-6"><label class="small text-muted">Jabatan</label><p class="fw-bold small">${p.Jabatan_Terakhir||'-'}</p></div></div></div></div></div>`;
        }

        async function editProfil() {
            const p=appData.profil||{}; try{const {value:v}=await Swal.fire({title:'Edit Profil',width:'600px',showCancelButton:true,confirmButtonText:'Simpan',html:`<div class="swal-form-group"><label class="swal-form-label">NIK (Kunci)</label><input class="form-control bg-light" value="${p.NIK||''}" readonly></div><div class="swal-form-group"><label class="swal-form-label">NIP</label><input id="s-nip" class="form-control" value="${p.NIP||''}"></div><div class="swal-form-group"><label class="swal-form-label">Nama</label><input id="s-nm" class="form-control" value="${p.Nama||''}"></div><div class="d-flex gap-2 mb-2"><div class="w-50"><input id="s-tm" class="form-control" placeholder="Tempat" value="${p.Tmp_Lahir||''}"></div><div class="w-50"><input id="s-tg" class="form-control" type="date" value="${p.Tgl_Lahir||''}"></div></div><div class="swal-form-group"><label class="swal-form-label">JK</label><select id="s-jk" class="form-select"><option value="L" ${p.JK=='L'?'selected':''}>Laki-laki</option><option value="P" ${p.JK=='P'?'selected':''}>Perempuan</option></select></div><div class="swal-form-group"><label class="swal-form-label">Email Kontak</label><input id="s-em" class="form-control" value="${p.Email||''}"></div><div class="swal-form-group"><label class="swal-form-label">HP</label><input id="s-hp" class="form-control" value="${p.No_HP||''}"></div><div class="swal-form-group"><label class="swal-form-label">Alamat</label><input id="s-al" class="form-control" value="${p.Alamat||''}"></div><div class="swal-form-group"><label class="swal-form-label">Pendidikan</label><input id="s-pd" class="form-control" value="${p.Pendidikan||''}"></div><div class="swal-form-group"><label class="swal-form-label">Jabatan</label><input id="s-jb" class="form-control" value="${p.Jabatan_Terakhir||''}"></div><div class="swal-form-group"><label class="swal-form-label">Foto</label><input type="file" id="s-ft" class="form-control"></div>`, preConfirm:async()=>{const f=document.getElementById('s-ft').files[0]; let u=p.Foto_Profil; if(f){const b=await toBase64(f);const r=await fetchGAS({action:'upload_file',base64:b.split(',')[1],mimeType:f.type,nik:currentUser.nik,type:'FOTO'}); if(r.status==='success')u=r.url;} return {NIP:document.getElementById('s-nip').value,Nama:document.getElementById('s-nm').value,Tmp_Lahir:document.getElementById('s-tm').value,Tgl_Lahir:document.getElementById('s-tg').value,JK:document.getElementById('s-jk').value,Email:document.getElementById('s-em').value,No_HP:document.getElementById('s-hp').value,Alamat:document.getElementById('s-al').value,Pendidikan:document.getElementById('s-pd').value,Jabatan_Terakhir:document.getElementById('s-jb').value,Foto_Profil:u};}}); if(v)saveData('tb_profil',v);}catch(e){Swal.fire('Error','Gagal','error')}
        }

        function renderTable(c,t,tn) { 
            const d=appData[tn]||[]; let h='';
            if(d.length>0) d.forEach((i,x)=>{ const b=i.Status_Verifikasi==='VERIFIED'?'success':'warning'; const f=i.Link_File?`<a href="${i.Link_File}" target="_blank" class="btn btn-sm btn-info me-1"><i class="fas fa-file"></i></a>`:''; h+=`<tr><td>${x+1}</td><td><b>${Object.values(i)[2]||'-'}</b><br>${Object.values(i)[3]||'-'}</td><td>${i.TMT||i.Tunjangan||'-'}</td><td><span class="badge bg-${b}">${i.Status_Verifikasi}</span></td><td>${f}<button onclick="deleteData('${tn}','${i.ID}')" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button></td></tr>`; }); else h='<tr><td colspan="5" class="text-center p-4">Kosong</td></tr>';
            c.innerHTML=`<div class="card p-4"><div class="d-flex justify-content-between mb-4"><h4 class="text-primary fw-bold text-capitalize">${t}</h4><button onclick="addData('${tn}')" class="btn btn-primary"><i class="fas fa-plus"></i> Tambah</button></div><div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>No</th><th>Detail</th><th>Ket</th><th>Status</th><th>Aksi</th></tr></thead><tbody>${h}</tbody></table></div></div>`;
        }
        
        async function addData(tn) {
            let h='';
            if(tn==='tb_pangkat') h=`<div class="swal-form-group"><label class="swal-form-label">Golongan</label><input id="f-1" class="form-control"></div><div class="swal-form-group"><label class="swal-form-label">Pangkat</label><input id="f-2" class="form-control"></div><div class="swal-form-group"><label class="swal-form-label">No SK</label><input id="f-3" class="form-control"></div><div class="swal-form-group"><label class="swal-form-label">Tgl SK</label><input type="date" id="f-4" class="form-control"></div><div class="swal-form-group"><label class="swal-form-label">TMT</label><input type="date" id="f-5" class="form-control"></div><div class="swal-form-group"><label class="swal-form-label">File</label><input type="file" id="f-f" class="form-control"></div>`;
            else if(tn==='tb_keluarga') h=`<div class="swal-form-group"><label class="swal-form-label">Nama</label><input id="f-1" class="form-control"></div><div class="swal-form-group"><label class="swal-form-label">NIK</label><input id="f-2" class="form-control"></div><div class="swal-form-group"><label class="swal-form-label">Hub</label><select id="f-3" class="form-select"><option>Suami</option><option>Istri</option><option>Anak</option></select></div><div class="swal-form-group"><label class="swal-form-label">JK</label><select id="f-4" class="form-select"><option>L</option><option>P</option></select></div><div class="swal-form-group"><label class="swal-form-label">Tgl Lahir</label><input type="date" id="f-5" class="form-control"></div><div class="swal-form-group"><label class="swal-form-label">Tunjangan</label><select id="f-6" class="form-select"><option>Ya</option><option>Tidak</option></select></div>`;
            else if(tn==='tb_jabatan') h=`<div class="swal-form-group"><label class="swal-form-label">Jabatan</label><input id="f-1" class="form-control"></div><div class="swal-form-group"><label class="swal-form-label">Jenis</label><select id="f-2" class="form-select"><option>Struktural</option><option>Fungsional</option></select></div><div class="swal-form-group"><label class="swal-form-label">Eselon</label><input id="f-3" class="form-control"></div><div class="swal-form-group"><label class="swal-form-label">Unit</label><input id="f-4" class="form-control"></div><div class="swal-form-group"><label class="swal-form-label">No SK</label><input id="f-5" class="form-control"></div><div class="swal-form-group"><label class="swal-form-label">TMT</label><input type="date" id="f-6" class="form-control"></div><div class="swal-form-group"><label class="swal-form-label">File</label><input type="file" id="f-f" class="form-control"></div>`;
            else if(tn==='tb_kartu') h=`<div class="swal-form-group"><label class="swal-form-label">Jenis</label><select id="f-1" class="form-select" onchange="document.getElementById('do').style.display=this.value==='Lainnya'?'block':'none'"><option>KTP</option><option>Kartu Keluarga</option><option>BPJS</option><option>NPWP</option><option>Karpeg</option><option>Taspen</option><option>Lainnya</option></select></div><div id="do" class="swal-form-group" style="display:none"><label class="swal-form-label">Tulis Jenis</label><input id="f-1-o" class="form-control"></div><div class="swal-form-group"><label class="swal-form-label">Nomor</label><input id="f-2" class="form-control"></div><div class="swal-form-group"><label class="swal-form-label">File</label><input type="file" id="f-f" class="form-control"></div>`;

            const {value:v}=await Swal.fire({title:'Tambah',html:h,showCancelButton:true,confirmButtonText:'Simpan',preConfirm:async()=>{
                const f=document.getElementById('f-f'); let u=''; if(f&&f.files[0]){const b=await toBase64(f.files[0]); const r=await fetchGAS({action:'upload_file',base64:b.split(',')[1],mimeType:f.files[0].type,nik:currentUser.nik,type:'DOC'}); if(r.status==='success')u=r.url;}
                if(tn==='tb_pangkat') return {Golongan:document.getElementById('f-1').value,Pangkat:document.getElementById('f-2').value,No_SK:document.getElementById('f-3').value,Tgl_SK:document.getElementById('f-4').value,TMT:document.getElementById('f-5').value,Link_File:u};
                if(tn==='tb_keluarga') return {Nama:document.getElementById('f-1').value,NIK_Anggota:document.getElementById('f-2').value,Hubungan:document.getElementById('f-3').value,JK:document.getElementById('f-4').value,Tgl_Lahir:document.getElementById('f-5').value,Tunjangan:document.getElementById('f-6').value};
                if(tn==='tb_jabatan') return {Nama_Jabatan:document.getElementById('f-1').value,Jenis_Jabatan:document.getElementById('f-2').value,Eselon:document.getElementById('f-3').value,Unit_Kerja:document.getElementById('f-4').value,No_SK:document.getElementById('f-5').value,TMT:document.getElementById('f-6').value,Link_File:u};
                if(tn==='tb_kartu') { let j=document.getElementById('f-1').value; if(j==='Lainnya')j=document.getElementById('f-1-o').value; return {Jenis_Kartu:j,No_Kartu:document.getElementById('f-2').value,Link_File:u}; }
            }});
            if(v)saveData(tn,v);
        }

        async function saveData(t,v,id=null,tk=null) { toggleLoading(true); const n=tk||currentUser.nik; const ia=currentUser.role==='ADMIN'; const p={action:'save_data',table:t,values:v,nik:n,isAdmin:ia}; if(id)p.values.ID=id; const r=await fetchGAS(p); if(r.status==='success'){ if(!tk||tk===currentUser.nik){const ref=await fetchGAS({action:'get_data',nik:currentUser.nik});if(ref.status==='success')appData=ref.data;} toggleLoading(false); Swal.fire('Sukses','Tersimpan','success').then(()=>{ if(tk&&ia)loadAdminMaster(); else if(t==='tb_profil')navTo('profil'); else navTo(t.split('_')[1]); }); }else{toggleLoading(false);Swal.fire('Error',r.message,'error')} }
        function deleteData(t,id) { Swal.fire({title:'Hapus?',icon:'warning',showCancelButton:true,confirmButtonText:'Ya'}).then(async(r)=>{if(r.isConfirmed){toggleLoading(true); await fetchGAS({action:'delete_data',table:t,id:id}); const ref=await fetchGAS({action:'get_data',nik:currentUser.nik}); appData=ref.data; toggleLoading(false); Swal.fire('Dihapus','','success'); document.querySelector('.nav-link.active').click(); }}); }
        async function fetchGAS(p) { const r=await fetch(GAS_URL,{method:'POST',body:JSON.stringify(p)}); return await r.json(); }

        // --- ADMIN ---
        function renderAdminDashboardV2(c) { c.innerHTML=`<div class="card p-4"><h4 class="fw-bold mb-3 text-primary">Admin Dashboard</h4><ul class="nav nav-tabs mb-3"><li class="nav-item"><button class="nav-link active" onclick="switchAT('antrean')">Antrean</button></li><li class="nav-item"><button class="nav-link" onclick="switchAT('master')">Master Pegawai</button></li><li class="nav-item"><button class="nav-link" onclick="switchAT('arsip')">Arsip Data</button></li></ul><div id="ac"></div></div>`; switchAT('antrean'); }
        function switchAT(t) { document.querySelectorAll('.nav-tabs button').forEach(b=>{b.classList.remove('active');if(b.innerText.toLowerCase().includes(t))b.classList.add('active')}); if(t==='antrean')loadAA(); else if(t==='master')loadAM(); else loadAAr(); }
        async function loadAA() { const c=document.getElementById('ac'); c.innerHTML='<div class="spinner-border text-primary"></div>'; const r=await fetchGAS({action:'admin_get_pending'}); if(r.status==='success'){adminData=r.data; renderAAT(c);}else c.innerHTML='Error'; }
        function renderAAT(c) { let h=''; const ts=[{id:'tb_profil',l:'Profil'},{id:'tb_pangkat',l:'Pangkat'},{id:'tb_jabatan',l:'Jabatan'},{id:'tb_keluarga',l:'Keluarga'},{id:'tb_kartu',l:'Kartu'}]; let hd=false; ts.forEach(t=>{const l=adminData[t.id]||[]; if(l.length>0){hd=true; let r=l.map(i=>`<tr><td><input type="checkbox" class="cb-${t.id}" value="${i.ID||i.NIK}" onchange="upVB('${t.id}')"></td><td><b>${i.Nama||'-'}</b><br>${i.NIK||i.NIK_Pegawai}</td><td><small>${JSON.stringify(i).slice(0,50)}...</small></td></tr>`).join(''); h+=`<div class="card mb-3"><div class="card-header d-flex justify-content-between"><b>${t.l}</b><button class="btn btn-sm btn-success" id="btn-v-${t.id}" onclick="exBV('${t.id}')" disabled>Verif</button></div><table class="table table-sm mb-0"><tbody>${r}</tbody></table></div>`}}); c.innerHTML=hd?h:'<div class="text-center p-4">Tidak ada antrean.</div>'; }
        async function loadAM() { const c=document.getElementById('ac'); c.innerHTML='<div class="spinner-border text-primary"></div>'; const r=await fetchGAS({action:'admin_get_table',table:'tb_profil'}); if(r.status==='success'){ const rw=r.data.map((p,i)=>`<tr><td>${i+1}</td><td><img src="${getImgUrl(p.Foto_Profil)}" class="rounded-circle me-2" width="40"><b>${p.Nama}</b><br>${p.NIP||p.NIK}</td><td>${p.Pendidikan||'-'}</td><td>${p.Jabatan_Terakhir||'-'}</td><td><span class="badge bg-${p.Status_Verifikasi==='VERIFIED'?'success':'warning'}">${p.Status_Verifikasi}</span></td><td><button onclick="showDetailUser('${p.NIK}')" class="btn btn-sm btn-info text-white me-1"><i class="fas fa-eye"></i></button> <button onclick="showFullEditUser('${p.NIK}')" class="btn btn-sm btn-warning text-dark"><i class="fas fa-pencil-alt"></i></button></td></tr>`).join(''); c.innerHTML=`<div class="mb-2"><input id="sm" class="form-control w-50" placeholder="Cari..." onkeyup="filtM()"></div><div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>No</th><th>Nama/NIP</th><th>Pend</th><th>Jabatan</th><th>Sts</th><th>Aksi</th></tr></thead><tbody id="tb-m">${rw}</tbody></table></div>`; } }
        function filtM() { const v=document.getElementById('sm').value.toLowerCase(); document.querySelectorAll('#tb-m tr').forEach(r=>{r.style.display=r.innerText.toLowerCase().includes(v)?'':'none'}); }
        
        // ADMIN SHOW DETAIL
        async function showDetailUser(targetNik) {
            Swal.fire({title:'Memuat...',didOpen:()=>{Swal.showLoading()}});
            const r = await fetchGAS({action:'get_data',nik:targetNik});
            if(r.status!=='success') return Swal.fire('Error',r.message,'error');
            const d=r.data, p=d.profil||{}; const url=getImgUrl(p.Foto_Profil);
            const renderRows=(l,c)=>{if(!l||l.length==0)return'<tr><td colspan="'+(c.length+1)+'" class="text-center small">Kosong</td></tr>'; return l.map((i,x)=>`<tr><td>${x+1}</td>${c.map(k=>`<td>${i[k]||'-'}</td>`).join('')}<td>${i.Link_File?'<a href="'+i.Link_File+'" target="_blank" class="btn btn-xs btn-outline-primary"><i class="fas fa-file"></i></a>':'-'}</td></tr>`).join('')};
            const html = `
                <div class="text-center mb-4"><img src="${url}" class="rounded-circle shadow-sm border p-1" style="width:80px;height:80px;object-fit:cover"><h5 class="mt-2 mb-0 fw-bold">${p.Nama}</h5><span class="badge bg-secondary">${p.NIK}</span></div>
                <div class="text-start"><div class="row small"><div class="col-6"><b>NIP:</b> ${p.NIP||'-'}</div><div class="col-6"><b>JK:</b> ${p.JK||'-'}</div><div class="col-6"><b>Agama:</b> ${p.Agama||'-'}</div><div class="col-6"><b>HP:</b> ${p.No_HP||'-'}</div></div>
                <hr class="my-2"><h6 class="fw-bold small">Riwayat Pangkat</h6><table class="table table-sm table-bordered" style="font-size:0.75rem"><thead><tr><th>No</th><th>Gol</th><th>Pangkat</th><th>TMT</th><th>File</th></tr></thead><tbody>${renderRows(d.tb_pangkat,['Golongan','Pangkat','TMT'])}</tbody></table>
                <h6 class="fw-bold small">Riwayat Jabatan</h6><table class="table table-sm table-bordered" style="font-size:0.75rem"><thead><tr><th>No</th><th>Jabatan</th><th>Unit</th><th>TMT</th><th>File</th></tr></thead><tbody>${renderRows(d.tb_jabatan,['Nama_Jabatan','Unit_Kerja','TMT'])}</tbody></table>
                <h6 class="fw-bold small">Keluarga</h6><table class="table table-sm table-bordered" style="font-size:0.75rem"><thead><tr><th>No</th><th>Nama</th><th>Hub</th><th>JK</th><th>File</th></tr></thead><tbody>${renderRows(d.tb_keluarga,['Nama','Hubungan','JK'])}</tbody></table>
                <h6 class="fw-bold small">Kartu</h6><table class="table table-sm table-bordered" style="font-size:0.75rem"><thead><tr><th>No</th><th>Jenis</th><th>Nomor</th><th>File</th></tr></thead><tbody>${renderRows(d.tb_kartu,['Jenis_Kartu','No_Kartu'])}</tbody></table></div>`;
            Swal.fire({html:html,width:'800px',showCloseButton:true,showConfirmButton:false});
        }

        // ADMIN FULL EDIT
        async function showFullEditUser(targetNik) {
            Swal.fire({title:'Memuat...',didOpen:()=>{Swal.showLoading()}});
            const r = await fetchGAS({action:'get_data',nik:targetNik});
            if(r.status!=='success') return Swal.fire('Error',r.message,'error');
            const d=r.data, p=d.profil||{};
            const renderRows=(l,c,t)=>{if(!l||l.length==0)return'<tr><td colspan="5" class="text-center">Kosong</td></tr>'; return l.map((i,x)=>`<tr><td>${x+1}</td>${c.map(k=>`<td>${i[k]||'-'}</td>`).join('')}<td><button class="btn btn-xs btn-warning p-0 px-1" onclick='editChildFromAdmin("${t}",${JSON.stringify(i)},"${targetNik}")'><i class="fas fa-pencil-alt"></i></button> <button class="btn btn-xs btn-danger p-0 px-1" onclick="deleteChildFromAdmin('${t}','${i.ID}','${targetNik}')"><i class="fas fa-trash"></i></button></td></tr>`).join('')};
            const html = `
                <div class="text-start">
                    <h6 class="fw-bold border-bottom pb-1">1. Edit Profil</h6>
                    <div class="row g-2 mb-3">
                        <div class="col-6"><label class="small fw-bold">NIP</label><input id="adm-nip" class="form-control form-control-sm" value="${p.NIP||''}"></div><div class="col-6"><label class="small fw-bold">Nama</label><input id="adm-nama" class="form-control form-control-sm" value="${p.Nama||''}"></div>
                        <div class="col-6"><label class="small fw-bold">Tempat</label><input id="adm-tmp" class="form-control form-control-sm" value="${p.Tmp_Lahir||''}"></div><div class="col-6"><label class="small fw-bold">Tgl Lahir</label><input type="date" id="adm-tgl" class="form-control form-control-sm" value="${p.Tgl_Lahir||''}"></div>
                        <div class="col-12"><label class="small fw-bold">Jabatan</label><input id="adm-jab" class="form-control form-control-sm" value="${p.Jabatan_Terakhir||''}"></div>
                        <div class="col-12"><button onclick="saveAdminProfil('${targetNik}')" class="btn btn-success btn-sm w-100">Simpan Profil</button></div>
                    </div>
                    <h6 class="fw-bold border-bottom pb-1 d-flex justify-content-between">2. Pangkat <button onclick="adminAddChild('tb_pangkat','${targetNik}')" class="btn btn-sm btn-primary py-0">+ Add</button></h6>
                    <table class="table table-sm table-bordered text-center mb-3" style="font-size:0.8rem"><thead><tr><th>No</th><th>Gol</th><th>Pangkat</th><th>TMT</th><th>Aksi</th></tr></thead><tbody>${renderRows(d.tb_pangkat,['Golongan','Pangkat','TMT'],'tb_pangkat')}</tbody></table>
                    <h6 class="fw-bold border-bottom pb-1 d-flex justify-content-between">3. Jabatan <button onclick="adminAddChild('tb_jabatan','${targetNik}')" class="btn btn-sm btn-primary py-0">+ Add</button></h6>
                    <table class="table table-sm table-bordered text-center mb-3" style="font-size:0.8rem"><thead><tr><th>No</th><th>Jabatan</th><th>Unit</th><th>TMT</th><th>Aksi</th></tr></thead><tbody>${renderRows(d.tb_jabatan,['Nama_Jabatan','Unit_Kerja','TMT'],'tb_jabatan')}</tbody></table>
                    <h6 class="fw-bold border-bottom pb-1 d-flex justify-content-between">4. Keluarga <button onclick="adminAddChild('tb_keluarga','${targetNik}')" class="btn btn-sm btn-primary py-0">+ Add</button></h6>
                    <table class="table table-sm table-bordered text-center mb-3" style="font-size:0.8rem"><thead><tr><th>No</th><th>Nama</th><th>Hub</th><th>Tunjangan</th><th>Aksi</th></tr></thead><tbody>${renderRows(d.tb_keluarga,['Nama','Hubungan','Tunjangan'],'tb_keluarga')}</tbody></table>
                    <h6 class="fw-bold border-bottom pb-1 d-flex justify-content-between">5. Kartu <button onclick="adminAddChild('tb_kartu','${targetNik}')" class="btn btn-sm btn-primary py-0">+ Add</button></h6>
                    <table class="table table-sm table-bordered text-center mb-3" style="font-size:0.8rem"><thead><tr><th>No</th><th>Jenis</th><th>Nomor</th><th>Aksi</th></tr></thead><tbody>${renderRows(d.tb_kartu,['Jenis_Kartu','No_Kartu'],'tb_kartu')}</tbody></table>
                </div>`;
            Swal.fire({ title: 'Edit Lengkap', html: html, width: '800px', showConfirmButton: false, showCloseButton: true });
        }

        async function saveAdminProfil(nik) {
            const v = { NIP: document.getElementById('adm-nip').value, Nama: document.getElementById('adm-nama').value, Tmp_Lahir: document.getElementById('adm-tmp').value, Tgl_Lahir: document.getElementById('adm-tgl').value, Jabatan_Terakhir: document.getElementById('adm-jab').value };
            await saveData('tb_profil', v, null, nik);
        }

        async function adminAddChild(t, nik) {
            let h=''; 
            if(t==='tb_pangkat') h=`<label>Golongan</label><input id="a-1" class="form-control mb-2"><label>Pangkat</label><input id="a-2" class="form-control mb-2"><label>TMT</label><input type="date" id="a-3" class="form-control">`;
            else if(t==='tb_jabatan') h=`<label>Jabatan</label><input id="a-1" class="form-control mb-2"><label>Unit</label><input id="a-2" class="form-control mb-2"><label>TMT</label><input type="date" id="a-3" class="form-control">`;
            else if(t==='tb_keluarga') h=`<label>Nama</label><input id="a-1" class="form-control mb-2"><label>Hubungan</label><select id="a-2" class="form-select"><option>Suami</option><option>Istri</option><option>Anak</option></select>`;
            else if(t==='tb_kartu') h=`<label>Jenis</label><select id="a-1" class="form-select mb-2"><option>KTP</option><option>BPJS</option><option>NPWP</option></select><label>Nomor</label><input id="a-2" class="form-control">`;
            
            const {value:v} = await Swal.fire({title:'Tambah', html:h, showCancelButton:true, confirmButtonText:'Simpan'});
            if(v) { 
                let vals={}; 
                if(t==='tb_pangkat') vals={Golongan:document.getElementById('a-1').value, Pangkat:document.getElementById('a-2').value, TMT:document.getElementById('a-3').value}; 
                else if(t==='tb_jabatan') vals={Nama_Jabatan:document.getElementById('a-1').value, Unit_Kerja:document.getElementById('a-2').value, TMT:document.getElementById('a-3').value}; 
                else if(t==='tb_keluarga') vals={Nama:document.getElementById('a-1').value, Hubungan:document.getElementById('a-2').value}; 
                else if(t==='tb_kartu') vals={Jenis_Kartu:document.getElementById('a-1').value, No_Kartu:document.getElementById('a-2').value};
                await saveData(t, vals, null, nik); showFullEditUser(nik); 
            }
        }

        async function editChildFromAdmin(t, item, nik) {
            let h=''; let vals={};
            if(t==='tb_pangkat') h=`<label>Golongan</label><input id="e-1" class="form-control mb-2" value="${item.Golongan}"><label>Pangkat</label><input id="e-2" class="form-control" value="${item.Pangkat}">`;
            else if(t==='tb_jabatan') h=`<label>Jabatan</label><input id="e-1" class="form-control mb-2" value="${item.Nama_Jabatan}"><label>Unit</label><input id="e-2" class="form-control" value="${item.Unit_Kerja}">`;
            else if(t==='tb_keluarga') h=`<label>Nama</label><input id="e-1" class="form-control" value="${item.Nama}">`;
            else if(t==='tb_kartu') h=`<label>Jenis</label><input id="e-1" class="form-control mb-2" value="${item.Jenis_Kartu}"><label>Nomor</label><input id="e-2" class="form-control" value="${item.No_Kartu}">`;
            
            const {value:v} = await Swal.fire({title:'Edit', html:h, showCancelButton:true, confirmButtonText:'Update'});
            if(v) { 
                 if(t==='tb_pangkat') vals={Golongan:document.getElementById('e-1').value, Pangkat:document.getElementById('e-2').value};
                 else if(t==='tb_jabatan') vals={Nama_Jabatan:document.getElementById('e-1').value, Unit_Kerja:document.getElementById('e-2').value};
                 else if(t==='tb_keluarga') vals={Nama:document.getElementById('e-1').value};
                 else if(t==='tb_kartu') vals={Jenis_Kartu:document.getElementById('e-1').value, No_Kartu:document.getElementById('e-2').value};
                 await saveData(t, vals, item.ID, nik); showFullEditUser(nik); 
            }
        }

        async function deleteChildFromAdmin(t, id, nik) {
             const {isConfirmed} = await Swal.fire({title:'Hapus?',icon:'warning',showCancelButton:true});
             if(isConfirmed) { await fetchGAS({action:'delete_data',table:t,id:id}); Swal.fire('Terhapus','','success'); showFullEditUser(nik); }
        }

        const sess=sessionStorage.getItem('simpeg_user'); if(sess){currentUser=JSON.parse(sess);initApp();}
    </script>
</body>
</html>
