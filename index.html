<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMPEG RSUD dr. R. Koesma</title>
    <!-- Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        :root { --primary: #005A9C; --secondary: #004080; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f9; }
        
        /* Layout Sidebar */
        .sidebar { 
            min-height: 100vh; width: 260px; background: var(--primary); color: white; 
            position: fixed; transition: all 0.3s; z-index: 1050; /* Z-index tinggi agar di atas overlay */
        }
        .sidebar .nav-link { color: rgba(255,255,255,0.8); margin: 5px 15px; border-radius: 8px; font-weight: 500; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { background: rgba(255,255,255,0.15); color: white; transform: translateX(5px); }
        .sidebar .nav-link i { width: 25px; }
        .main-content { margin-left: 260px; padding: 25px; transition: all 0.3s; }
        
        /* Mobile Overlay (Layar Gelap saat Menu Buka) */
        .sidebar-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1040;
        }
        .sidebar-overlay.active { display: block; }

        /* Mobile Specifics */
        @media (max-width: 768px) {
            .sidebar { margin-left: -260px; }
            .sidebar.active { margin-left: 0; }
            .main-content { margin-left: 0; }
        }

        /* --- SWEETALERT2 PROFESSIONAL CUSTOMIZATION --- */
        .swal2-popup {
            font-size: 0.9rem !important; /* Perkecil font body */
            border-radius: 12px !important;
            padding: 1.5em !important;
        }
        .swal2-title {
            font-size: 1.4rem !important; /* Perkecil judul */
            font-weight: 700 !important;
            color: #333 !important;
        }
        .swal2-html-container {
            font-size: 0.95rem !important;
            color: #555 !important;
        }
        .swal2-actions {
            margin-top: 1em !important;
        }
        .swal2-styled {
            padding: 0.5em 1.2em !important; /* Tombol lebih ramping */
            font-size: 0.9rem !important;
            border-radius: 6px !important;
        }
        /* Fix input di Swal agar tidak terlalu besar */
        .swal2-input, .swal2-select {
            font-size: 0.9rem !important;
            height: 2.4em !important;
            margin: 0.5em auto !important;
        }

        /* Components & Login (Tetap Sama) */
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .status-badge-DRAFT { background: #fff3cd; color: #856404; padding: 4px 10px; border-radius: 20px; font-size: 0.8em; font-weight: bold; border: 1px solid #ffeeba; }
        .status-badge-VERIFIED { background: #d4edda; color: #155724; padding: 4px 10px; border-radius: 20px; font-size: 0.8em; font-weight: bold; border: 1px solid #c3e6cb; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .table-admin th { background-color: #f8f9fa; font-size: 0.85rem; text-transform: uppercase; }
        .nav-tabs .nav-link { cursor: pointer; color: #6c757d; }
        .nav-tabs .nav-link.active { border-bottom: 3px solid var(--primary); color: var(--primary); font-weight: bold; border-top: none; border-left: none; border-right: none; }
        
        .login-wrapper { min-height: 100vh; background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%); display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card-modern { background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.08); width: 100%; max-width: 420px; padding: 40px; position: relative; overflow: hidden; }
        .login-card-modern::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: linear-gradient(90deg, var(--primary), var(--secondary)); }
        .login-header { text-align: center; margin-bottom: 35px; }
        .login-header img { width: 80px; margin-bottom: 15px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        .login-header h4 { font-weight: 800; color: #2d3748; letter-spacing: -0.5px; margin-bottom: 5px; }
        .login-header p { color: #718096; font-size: 0.9rem; }
        .form-modern .form-label { font-size: 0.85rem; font-weight: 600; color: #4a5568; margin-left: 4px; }
        .form-modern .form-control { padding: 12px 18px; border-radius: 10px; border: 1px solid #e2e8f0; background-color: #f7fafc; font-size: 0.95rem; transition: all 0.3s ease; }
        .form-modern .form-control:focus { background-color: white; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 90, 156, 0.15); }
        .btn-primary-modern { background: var(--primary); background: linear-gradient(to right, var(--primary), var(--secondary)); border: none; color: white; padding: 12px; border-radius: 10px; font-weight: 700; letter-spacing: 0.5px; width: 100%; margin-top: 10px; transition: transform 0.2s, box-shadow 0.2s; }
        .btn-primary-modern:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0, 90, 156, 0.3); color: white; }
        .auth-separator { display: flex; align-items: center; text-align: center; color: #cbd5e0; margin: 25px 0; }
        .auth-separator::before, .auth-separator::after { content: ''; flex: 1; border-bottom: 1px solid #e2e8f0; }
        .auth-separator span { padding: 0 10px; font-size: 0.75rem; font-weight: 600; color: #a0aec0; }
        .auth-footer { text-align: center; margin-top: 25px; font-size: 0.9rem; color: #718096; }
        .auth-footer a { color: var(--primary); font-weight: 700; text-decoration: none; cursor: pointer; transition: color 0.2s; }
        .auth-footer a:hover { color: var(--secondary); text-decoration: underline; }
        .animate-fade { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
        <h5 class="mt-3 text-primary fw-bold">Memproses Data...</h5>
    </div>

    <!-- LOGIN SECTION -->
    <div id="app-login" class="login-wrapper">
        <div class="login-card-modern animate-fade">
            <div class="login-header">
                <img src="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png" alt="Logo RSUD">
                <h4>SIMPEG RSUD</h4>
                <p>Sistem Informasi Kepegawaian <br>RSUD dr. R. Koesma Tuban</p>
            </div>

            <!-- VIEW: LOGIN FORM -->
            <div id="view-auth-login">
                <form onsubmit="handleLogin(event)" class="form-modern">
                    <div class="mb-3"><label class="form-label">NIK atau Email</label><input type="text" id="l-identifier" class="form-control" placeholder="Masukkan NIK atau Email Anda" required></div>
                    <div class="mb-2"><label class="form-label">Kata Sandi</label><input type="password" id="l-pass" class="form-control" placeholder="••••••••" required></div>
                    <div class="text-end mb-4"><a href="#" onclick="forgotPassword()" class="text-decoration-none small text-primary fw-bold">Lupa Password?</a></div>
                    <button type="submit" class="btn-primary-modern">Masuk Aplikasi</button>
                </form>
                <div class="auth-separator"><span>ATAU MASUK DENGAN</span></div>
                <div class="d-flex justify-content-center">
                    <div id="g_id_onload" data-client_id="783459415718-mp0vsmd2lopajf2ut0aqc6drjrs95pu8.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_prompt="false"></div>
                    <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="outline" data-text="signin_with" data-size="large" data-logo_alignment="left" data-width="340"></div>
                </div>
                <div class="auth-footer">Belum memiliki akun? <a onclick="switchAuthMode('register')">Daftar sekarang</a></div>
            </div>

            <!-- VIEW: REGISTER FORM -->
            <div id="view-auth-register" class="d-none">
                <form onsubmit="handleRegister(event)" class="form-modern">
                    <div class="mb-3"><label class="form-label">NIK (Sesuai KTP)</label><input type="number" id="r-nik" class="form-control" placeholder="16 Digit NIK" required minlength="16"></div>
                    <div class="mb-3"><label class="form-label">Nama Lengkap</label><input type="text" id="r-nama" class="form-control" placeholder="Nama Lengkap Tanpa Gelar" required></div>
                    <div class="mb-3"><label class="form-label">Email (Opsional / Gmail)</label><input type="email" id="r-email" class="form-control" placeholder="contoh@gmail.com"><div class="form-text text-muted" style="font-size: 0.8rem;">Gunakan Gmail jika ingin login dengan Google nanti.</div></div>
                    <div class="mb-4"><label class="form-label">Buat Kata Sandi</label><input type="password" id="r-pass" class="form-control" placeholder="Min. 6 Karakter" required minlength="6"></div>
                    <button type="submit" class="btn-primary-modern" style="background: linear-gradient(to right, #198754, #157347);">Daftar Akun Baru</button>
                </form>
                <div class="auth-footer">Sudah punya akun? <a onclick="switchAuthMode('login')">Masuk disini</a></div>
            </div>
        </div>
    </div>

    <!-- MAIN APP SECTION -->
    <div id="app-main" class="d-none">
        
        <!-- Overlay untuk Mobile -->
        <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <div class="sidebar d-flex flex-column p-3" id="sidebar">
            <div class="d-flex justify-content-between align-items-center mb-4 text-white">
                <div class="text-center w-100">
                    <img src="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png" width="50" class="bg-white rounded-circle p-1 mb-2">
                    <h6 class="fw-bold mb-0">SIMPEG RSUD</h6>
                    <small id="user-display-name" class="text-white-50">User</small>
                </div>
                <!-- Tombol Close Sidebar (Hanya di Mobile) -->
                <button class="btn btn-sm text-white d-md-none position-absolute top-0 end-0 m-3" onclick="toggleSidebar()">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            
            <ul class="nav flex-column mb-auto">
                <li class="nav-item"><a href="#" class="nav-link active" onclick="navTo('profil')"><i class="fas fa-user-circle"></i> Profil Pegawai</a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="navTo('pangkat')"><i class="fas fa-medal"></i> Riwayat Pangkat</a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="navTo('jabatan')"><i class="fas fa-briefcase"></i> Riwayat Jabatan</a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="navTo('keluarga')"><i class="fas fa-users"></i> Anggota Keluarga</a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="navTo('kartu')"><i class="fas fa-id-card"></i> Data Kartu</a></li>
                <li class="nav-item d-none" id="menu-admin"><a href="#" class="nav-link bg-danger text-white mt-3" onclick="navTo('admin')"><i class="fas fa-user-shield"></i> Admin Dashboard</a></li>
            </ul>
            <div class="mt-auto"><button onclick="logout()" class="btn btn-outline-light w-100"><i class="fas fa-sign-out-alt"></i> Logout</button></div>
        </div>

        <!-- Content -->
        <div class="main-content" id="main-content">
            <button class="btn btn-primary d-md-none mb-3" onclick="toggleSidebar()"><i class="fas fa-bars"></i> Menu</button>
            <div id="view-container"></div>
        </div>
    </div>

    <!-- Javascript Logic -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwgNdoZPiFJNdbM8tBmx1lGwonOj92sI8fgYUvEjR_x2Q-nwq9z_vkTq1MqMZG1MTAO/exec'; 
        let currentUser = null;
        let appData = {}; 
        let adminData = {}; 
        let selectedIds = []; 

        function toggleLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }

        // [NEW] Sidebar Toggle Logic
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        // [HELPER] FIX IMAGE URL
        function getImgUrl(url) {
            if (!url || url.length < 5) return 'https://via.placeholder.com/150';
            if (url.includes('drive.google.com/file/d/')) {
                try {
                    const id = url.split('/d/')[1].split('/')[0];
                    return `https://lh3.googleusercontent.com/d/${id}`;
                } catch(e) { return url; }
            }
            return url;
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function switchAuthMode(mode) {
            const loginView = document.getElementById('view-auth-login');
            const registerView = document.getElementById('view-auth-register');
            if (mode === 'register') { loginView.classList.add('d-none'); registerView.classList.remove('d-none'); registerView.classList.add('animate-fade'); } 
            else { registerView.classList.add('d-none'); loginView.classList.remove('d-none'); loginView.classList.add('animate-fade'); }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const identifier = document.getElementById('l-identifier').value;
            const pass = document.getElementById('l-pass').value;
            toggleLoading(true);
            const res = await fetchGAS({ action: 'login', identifier: identifier, password: pass });
            toggleLoading(false);
            if (res.status === 'success') loginSuccess(res.user); else Swal.fire('Gagal', res.message, 'error');
        }

        async function handleRegister(e) {
            e.preventDefault();
            const nik = document.getElementById('r-nik').value;
            const nama = document.getElementById('r-nama').value;
            const email = document.getElementById('r-email').value;
            const pass = document.getElementById('r-pass').value;
            if (!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,}$/.test(pass)) { Swal.fire('Password Lemah', 'Min 6 karakter (Huruf & Angka).', 'warning'); return; }
            toggleLoading(true);
            const res = await fetchGAS({ action: 'register', nik, nama, email, password: pass });
            toggleLoading(false);
            if (res.status === 'success') { Swal.fire('Berhasil', 'Akun dibuat.', 'success'); switchAuthMode('login'); } else Swal.fire('Gagal', res.message, 'error');
        }

        async function forgotPassword() {
            const { value: identifier } = await Swal.fire({
                title: 'Reset Password',
                text: 'Masukkan NIK atau Email yang terdaftar:',
                input: 'text',
                inputPlaceholder: 'NIK / Email',
                showCancelButton: true,
                confirmButtonText: 'Kirim Password Baru',
                confirmButtonColor: '#005A9C',
                showLoaderOnConfirm: true,
                preConfirm: async (loginInfo) => {
                    if (!loginInfo) { Swal.showValidationMessage('Data tidak boleh kosong'); return false; }
                    try {
                        const response = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'forgot_password', identifier: loginInfo }) });
                        const result = await response.json();
                        if (result.status !== 'success') throw new Error(result.message);
                        return result.message;
                    } catch (error) { Swal.showValidationMessage(`Gagal: ${error.message}`); }
                },
                allowOutsideClick: () => !Swal.isLoading()
            });
            if (identifier) Swal.fire({ title: 'Berhasil!', text: identifier, icon: 'success' });
        }

        function handleCredentialResponse(response) {
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            toggleLoading(true);
            fetchGAS({ action: 'google_login', email: payload.email }).then(res => {
                toggleLoading(false);
                if (res.status === 'success') loginSuccess(res.user); else Swal.fire('Akses Ditolak', res.message, 'error');
            });
        }

        function loginSuccess(user) {
            currentUser = user;
            sessionStorage.setItem('simpeg_user', JSON.stringify(user));
            if(window.location.hash === '#admin' && user.role !== 'ADMIN') { Swal.fire('Akses Ditolak', 'Anda bukan Admin.', 'warning'); window.location.hash = ''; }
            initApp();
        }

        function logout() { sessionStorage.removeItem('simpeg_user'); window.location.reload(); }

        async function initApp() {
            document.getElementById('app-login').classList.add('d-none');
            document.getElementById('app-main').classList.remove('d-none');
            document.getElementById('user-display-name').innerText = currentUser.nama;
            if (currentUser.role === 'ADMIN') document.getElementById('menu-admin').classList.remove('d-none');
            toggleLoading(true);
            const res = await fetchGAS({ action: 'get_data', nik: currentUser.nik });
            toggleLoading(false);
            if (res.status === 'success') {
                appData = res.data;
                if (window.location.hash === '#admin' && currentUser.role === 'ADMIN') navTo('admin'); else navTo('profil');
            }
        }

        function navTo(page) {
            // [MODIFIED] Auto close sidebar on mobile when navigating
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('sidebar-overlay').classList.remove('active');
            }

            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            const menu = document.querySelector(`[onclick="navTo('${page}')"]`);
            if(menu) menu.classList.add('active');
            const container = document.getElementById('view-container');
            if (page === 'profil') renderProfil(container);
            else if (page === 'pangkat') renderTable(container, 'Riwayat Pangkat', appData.tb_pangkat, 'tb_pangkat');
            else if (page === 'jabatan') renderTable(container, 'Riwayat Jabatan', appData.tb_jabatan, 'tb_jabatan');
            else if (page === 'keluarga') renderTable(container, 'Anggota Keluarga', appData.tb_keluarga, 'tb_keluarga');
            else if (page === 'kartu') renderTable(container, 'Data Kartu Identitas', appData.tb_kartu, 'tb_kartu');
            else if (page === 'admin') renderAdminDashboardV2(container);
        }

        function renderProfil(container) {
            const p = appData.profil || {};
            const imgSrc = getImgUrl(p.Foto_Profil);
            const statusBadge = `<span class="status-badge-${p.Status_Verifikasi || 'DRAFT'}">${p.Status_Verifikasi || 'DRAFT'}</span>`;
            const loginEmail = currentUser.email_login ? currentUser.email_login.toLowerCase().trim() : '';
            const profileEmail = p.Email ? p.Email.toLowerCase().trim() : '';
            let emailNote = '';
            if (profileEmail && loginEmail && profileEmail === loginEmail) emailNote = `<span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25" style="font-size: 0.7em;"><i class="fas fa-check-circle"></i> Terhubung Login</span>`;
            else if (profileEmail) emailNote = `<span class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25" style="font-size: 0.7em;"><i class="fas fa-info-circle"></i> Kontak Saja</span>`;

            container.innerHTML = `
                <div class="card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                        <h4 class="fw-bold text-primary mb-0">Profil Pegawai</h4>
                        <div>${statusBadge} <button onclick="editProfil()" class="btn btn-sm btn-primary ms-2"><i class="fas fa-edit"></i> Edit Data</button></div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 text-center mb-3">
                            <img src="${imgSrc}" class="img-thumbnail rounded-circle mb-2" style="width: 150px; height: 150px; object-fit: cover;">
                            <h5 class="fw-bold">${p.Nama || 'Nama Pegawai'}</h5>
                            <p class="text-muted">${p.NIP || '-'}</p>
                        </div>
                        <div class="col-md-9">
                            <div class="row g-3">
                                <div class="col-md-6"><label class="small text-muted">NIK</label><p class="fw-bold">${p.NIK || '-'}</p></div>
                                <div class="col-md-6"><label class="small text-muted">Tgl Lahir</label><p class="fw-bold">${p.Tmp_Lahir||'-'}, ${p.Tgl_Lahir||'-'}</p></div>
                                <div class="col-md-6"><label class="small text-muted">JK</label><p class="fw-bold">${p.JK||'-'}</p></div>
                                <div class="col-md-6"><label class="small text-muted">Email Kontak</label><p class="fw-bold mb-1">${p.Email||'-'}</p>${emailNote}</div>
                                <div class="col-md-12"><label class="small text-muted">Alamat</label><p class="fw-bold">${p.Alamat||'-'}</p></div>
                                <div class="col-md-6"><label class="small text-muted">Pendidikan</label><p class="fw-bold">${p.Pendidikan||'-'}</p></div>
                                <div class="col-md-6"><label class="small text-muted">Jabatan</label><p class="fw-bold">${p.Jabatan_Terakhir||'-'}</p></div>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        async function editProfil() {
            const p = appData.profil || {};
            try {
                const { value: formValues } = await Swal.fire({
                    title: 'Edit Profil', width: '600px', showCancelButton: true, confirmButtonText: 'Simpan',
                    html: `
                        <input id="sw-nip" class="swal2-input" placeholder="NIP" value="${p.NIP||''}">
                        <input id="sw-nama" class="swal2-input" placeholder="Nama Lengkap" value="${p.Nama||''}">
                        <div class="d-flex gap-2 mx-5 mt-3"><input id="sw-tmp" class="form-control" placeholder="Tmp Lahir" value="${p.Tmp_Lahir||''}"><input id="sw-tgl" class="form-control" type="date" value="${p.Tgl_Lahir||''}"></div>
                        <select id="sw-jk" class="swal2-select" style="width:80%; margin: 10px auto; display:block;"><option value="L" ${p.JK=='L'?'selected':''}>Laki-laki</option><option value="P" ${p.JK=='P'?'selected':''}>Perempuan</option></select>
                        <input id="sw-email" class="swal2-input" placeholder="Email Kontak" value="${p.Email||''}">
                        <div class="text-muted small mx-5 mb-2" style="font-size:0.7em">*Tidak mengubah email login.</div>
                        <input id="sw-hp" class="swal2-input" placeholder="Nomor HP" value="${p.No_HP||''}">
                        <input id="sw-alamat" class="swal2-input" placeholder="Alamat Domisili" value="${p.Alamat||''}">
                        <input id="sw-pend" class="swal2-input" placeholder="Pendidikan Terakhir" value="${p.Pendidikan||''}">
                        <input id="sw-jab" class="swal2-input" placeholder="Jabatan Terakhir" value="${p.Jabatan_Terakhir||''}">
                        <div class="mx-5 mt-3 text-start"><label class="small">Foto Profil</label><input type="file" id="sw-foto" class="form-control"></div>
                    `,
                    preConfirm: async () => {
                        const fileInput = document.getElementById('sw-foto').files[0];
                        let fotoUrl = p.Foto_Profil;
                        if (fileInput) {
                            const base64 = await toBase64(fileInput);
                            const upRes = await fetchGAS({ action: 'upload_file', base64: base64.split(',')[1], mimeType: fileInput.type, nik: currentUser.nik, type: 'FOTO' });
                            if(upRes.status === 'success') fotoUrl = upRes.url;
                        }
                        return {
                            NIP: document.getElementById('sw-nip').value, Nama: document.getElementById('sw-nama').value, Tmp_Lahir: document.getElementById('sw-tmp').value, Tgl_Lahir: document.getElementById('sw-tgl').value,
                            JK: document.getElementById('sw-jk').value, Email: document.getElementById('sw-email').value, No_HP: document.getElementById('sw-hp').value, Alamat: document.getElementById('sw-alamat').value, Pendidikan: document.getElementById('sw-pend').value, Jabatan_Terakhir: document.getElementById('sw-jab').value, Foto_Profil: fotoUrl
                        };
                    }
                });
                if (formValues) saveData('tb_profil', formValues);
            } catch (err) { console.error(err); Swal.fire('Error', 'Terjadi kesalahan.', 'error'); }
        }

        function renderAdminDashboardV2(container) {
            container.innerHTML = `
                <div class="card p-4">
                    <h3 class="fw-bold mb-4 text-primary"><i class="fas fa-user-shield"></i> Admin Dashboard</h3>
                    <ul class="nav nav-tabs mb-4">
                        <li class="nav-item"><button class="nav-link active" onclick="switchAdminTab('antrean')">Antrean Verifikasi</button></li>
                        <li class="nav-item"><button class="nav-link" onclick="switchAdminTab('master')">Master Data Pegawai</button></li>
                        <li class="nav-item"><button class="nav-link" onclick="switchAdminTab('arsip')">Arsip Data</button></li>
                    </ul>
                    <div id="admin-content"></div>
                </div>`;
            switchAdminTab('antrean');
        }

        function switchAdminTab(tabName) {
            const tabs = document.querySelectorAll('#adminTabs button, .nav-tabs button');
            tabs.forEach(btn => {
                btn.classList.remove('active');
                if (btn.innerText.toLowerCase().includes(tabName) || (tabName === 'antrean' && btn.innerText.includes('Antrean')) || (tabName === 'master' && btn.innerText.includes('Master')) || (tabName === 'arsip' && btn.innerText.includes('Arsip'))) { btn.classList.add('active'); }
            });
            if (tabName === 'antrean') loadAdminAntrean();
            else if (tabName === 'master') loadAdminMaster();
            else if (tabName === 'arsip') loadAdminArsipView();
        }

        async function loadAdminAntrean() {
            const content = document.getElementById('admin-content');
            content.innerHTML = '<div class="spinner-border text-primary"></div>';
            const res = await fetchGAS({ action: 'admin_get_pending' });
            if(res.status === 'success') { adminData = res.data; renderAntreanTables(content); } else content.innerHTML = `<div class="alert alert-danger">${res.message}</div>`;
        }

        function renderAntreanTables(container) {
            let html = '';
            const tables = [{ id: 'tb_profil', label: 'Profil' }, { id: 'tb_pangkat', label: 'Pangkat' }, { id: 'tb_jabatan', label: 'Jabatan' }, { id: 'tb_keluarga', label: 'Keluarga' }, { id: 'tb_kartu', label: 'Kartu' }];
            let hasData = false;
            tables.forEach(t => {
                const list = adminData[t.id] || [];
                if(list.length > 0) {
                    hasData = true;
                    let rows = list.map(item => `<tr><td><input type="checkbox" class="cb-${t.id}" value="${item.ID||item.NIK}" onchange="updateVerifyBtn('${t.id}')"></td><td><b>${item.Nama||'-'}</b><br>${item.NIK||item.NIK_Pegawai}</td><td><small>${JSON.stringify(item).slice(0,50)}...</small></td><td>${item.Link_File ? '<a href="'+item.Link_File+'" target="_blank">File</a>' : '-'}</td></tr>`).join('');
                    html += `<div class="card mb-3"><div class="card-header d-flex justify-content-between"><b>${t.label}</b> <button class="btn btn-sm btn-success" id="btn-verify-${t.id}" onclick="execBulkVerify('${t.id}')" disabled>Verifikasi</button></div><div class="table-responsive"><table class="table table-sm mb-0"><thead><tr><th width="30"><input type="checkbox" onchange="toggleSelectAll('${t.id}',this)"></th><th>Identitas</th><th>Info</th><th>Dok</th></tr></thead><tbody>${rows}</tbody></table></div></div>`;
                }
            });
            container.innerHTML = hasData ? html : '<div class="text-center py-5 text-muted">Tidak ada antrean.</div>';
        }

        async function loadAdminMaster() {
            const container = document.getElementById('admin-content');
            container.innerHTML = '<div class="spinner-border text-primary"></div>';
            const res = await fetchGAS({ action: 'admin_get_table', table: 'tb_profil' });
            if(res.status === 'success') {
                const rows = res.data.map((p,i) => `
                    <tr class="master-row">
                        <td>${i+1}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <img src="${getImgUrl(p.Foto_Profil)}" class="rounded-circle me-2" width="40">
                                <div><div class="fw-bold master-name">${p.Nama}</div><div class="small text-muted master-nip">${p.NIP || p.NIK}</div></div>
                            </div>
                        </td>
                        <td>${p.Pendidikan || '-'}</td>
                        <td>${p.Jabatan_Terakhir || '-'}</td>
                        <td><span class="badge bg-${p.Status_Verifikasi==='VERIFIED'?'success':'warning'}">${p.Status_Verifikasi}</span></td>
                        <td><button onclick="showDetailUser('${encodeURIComponent(JSON.stringify(p))}')" class="btn btn-sm btn-info text-white"><i class="fas fa-eye"></i></button></td>
                    </tr>`).join('');
                container.innerHTML = `<div class="d-flex justify-content-between mb-3"><input type="text" id="search-master" class="form-control w-50" placeholder="Cari..." onkeyup="filterMasterTable()"><button class="btn btn-outline-primary" onclick="loadAdminMaster()"><i class="fas fa-sync"></i> Refresh</button></div><div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>No</th><th>Nama/NIP</th><th>Pend.</th><th>Jabatan</th><th>Status</th><th>Aksi</th></tr></thead><tbody>${rows}</tbody></table></div>`;
            }
        }

        function filterMasterTable() {
            const input = document.getElementById('search-master').value.toLowerCase();
            const rows = document.querySelectorAll('.master-row');
            rows.forEach(row => {
                const name = row.querySelector('.master-name').innerText.toLowerCase();
                const nip = row.querySelector('.master-nip').innerText.toLowerCase();
                if(name.includes(input) || nip.includes(input)) row.style.display = ''; else row.style.display = 'none';
            });
        }

        function showDetailUser(pStr) {
            const p = JSON.parse(decodeURIComponent(pStr));
            Swal.fire({
                title: 'Detail Pegawai',
                html: `<div class="text-start"><table class="table table-sm table-borderless"><tr><td width="30%"><strong>Nama</strong></td><td>: ${p.Nama}</td></tr><tr><td><strong>NIK</strong></td><td>: ${p.NIK}</td></tr><tr><td><strong>Pendidikan</strong></td><td>: ${p.Pendidikan||'-'}</td></tr><tr><td><strong>Jabatan</strong></td><td>: ${p.Jabatan_Terakhir||'-'}</td></tr><tr><td><strong>Email</strong></td><td>: ${p.Email||'-'}</td></tr><tr><td><strong>No HP</strong></td><td>: ${p.No_HP||'-'}</td></tr></table></div>`,
                width: '500px'
            });
        }

        function loadAdminArsipView() {
            const container = document.getElementById('admin-content');
            container.innerHTML = `<div class="d-flex gap-3 mb-3 align-items-center p-3 bg-light rounded border"><label class="fw-bold">Pilih Data:</label><select id="arsip-type" class="form-select w-auto"><option value="tb_pangkat">Riwayat Pangkat</option><option value="tb_jabatan">Riwayat Jabatan</option><option value="tb_keluarga">Anggota Keluarga</option><option value="tb_kartu">Kartu Identitas</option></select><button class="btn btn-primary" onclick="fetchArsipData()"><i class="fas fa-sync"></i> Muat Data</button></div><div id="arsip-data-container" class="table-responsive"><div class="text-center text-muted p-4">Silakan pilih jenis data.</div></div>`;
            fetchArsipData();
        }

        async function fetchArsipData() {
            const tableType = document.getElementById('arsip-type').value;
            const dataContainer = document.getElementById('arsip-data-container');
            dataContainer.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary"></div></div>';
            const res = await fetchGAS({ action: 'admin_get_table', table: tableType });
            if(res.status === 'success') {
                const data = res.data;
                if(data.length === 0) { dataContainer.innerHTML = '<div class="alert alert-warning">Tidak ada data.</div>'; return; }
                const headers = Object.keys(data[0]).filter(k => k !== 'ID' && k !== 'Link_File' && k !== 'Status_Verifikasi');
                let thead = '<tr><th>No</th>' + headers.map(h => `<th>${h}</th>`).join('') + '<th>File</th><th>Status</th></tr>';
                let tbody = '';
                data.forEach((row, idx) => {
                    let cells = headers.map(h => `<td>${row[h] || '-'}</td>`).join('');
                    let fileBtn = row.Link_File ? `<a href="${row.Link_File}" target="_blank" class="btn btn-sm btn-info"><i class="fas fa-file"></i></a>` : '-';
                    let badgeClass = row.Status_Verifikasi === 'VERIFIED' ? 'success' : 'warning';
                    tbody += `<tr><td>${idx+1}</td>${cells}<td>${fileBtn}</td><td><span class="badge bg-${badgeClass}">${row.Status_Verifikasi}</span></td></tr>`;
                });
                dataContainer.innerHTML = `<table class="table table-sm table-bordered table-hover mt-2"><thead class="table-light">${thead}</thead><tbody>${tbody}</tbody></table>`;
            } else dataContainer.innerHTML = `<div class="alert alert-danger">${res.message}</div>`;
        }

        function toggleSelectAll(tId, src) { document.querySelectorAll(`.cb-${tId}`).forEach(c => c.checked = src.checked); updateVerifyBtn(tId); }
        function updateVerifyBtn(tId) { const c = document.querySelectorAll(`.cb-${tId}:checked`).length; document.getElementById(`btn-verify-${tId}`).disabled = c === 0; }
        async function execBulkVerify(tId) {
            const ids = Array.from(document.querySelectorAll(`.cb-${tId}:checked`)).map(c => c.value);
            if(ids.length === 0) return;
            toggleLoading(true);
            const res = await fetchGAS({ action: 'admin_bulk_verify', table: tId, ids });
            toggleLoading(false);
            if(res.status==='success') { Swal.fire('Sukses',res.message,'success'); loadAdminAntrean(); } else Swal.fire('Error',res.message,'error');
        }

        function renderTable(container, title, data, tableName) {
            let rows = '';
            if (data && data.length > 0) {
                data.forEach((item, index) => {
                    const badge = `<span class="status-badge-${item.Status_Verifikasi}">${item.Status_Verifikasi}</span>`;
                    let info = '';
                    if (tableName === 'tb_pangkat') info = `<b>${item.Pangkat}</b><br>SK: ${item.No_SK}`;
                    else if (tableName === 'tb_jabatan') info = `<b>${item.Nama_Jabatan}</b><br>${item.Unit_Kerja}`;
                    else if (tableName === 'tb_keluarga') info = `<b>${item.Nama}</b> (${item.Hubungan})`;
                    else info = `<b>${item.Jenis_Kartu}</b><br>${item.No_Kartu}`;
                    const btnFile = item.Link_File ? `<a href="${item.Link_File}" target="_blank" class="btn btn-sm btn-info me-1"><i class="fas fa-file"></i></a>` : '';
                    rows += `<tr><td>${index+1}</td><td>${info}</td><td>${item.TMT||item.Tunjangan||'-'}</td><td>${badge}</td><td>${btnFile}<button onclick="deleteData('${tableName}', '${item.ID}')" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button></td></tr>`;
                });
            } else rows = '<tr><td colspan="5" class="text-center p-4">Belum ada data.</td></tr>';
            container.innerHTML = `<div class="card p-4"><div class="d-flex justify-content-between mb-4"><h4 class="text-primary fw-bold">${title}</h4><button onclick="addData('${tableName}')" class="btn btn-primary"><i class="fas fa-plus"></i> Tambah</button></div><div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>No</th><th>Detail</th><th>Ket</th><th>Status</th><th>Aksi</th></tr></thead><tbody>${rows}</tbody></table></div></div>`;
        }

        async function saveData(tableName, values, id = null) {
            toggleLoading(true);
            const payload = { action: 'save_data', table: tableName, values: values, nik: currentUser.nik };
            if (id) payload.values.ID = id;
            const res = await fetchGAS(payload);
            if (res.status === 'success') {
                const refresh = await fetchGAS({ action: 'get_data', nik: currentUser.nik });
                if (refresh.status === 'success') appData = refresh.data;
                toggleLoading(false);
                Swal.fire('Berhasil', 'Data disimpan', 'success').then(() => { if(tableName === 'tb_profil') navTo('profil'); else navTo(tableName.split('_')[1]); });
            } else { toggleLoading(false); Swal.fire('Error', res.message, 'error'); }
        }

        function deleteData(tableName, id) {
            Swal.fire({ title: 'Hapus Data?', text: "Data hilang permanen!", icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya, Hapus' }).then(async (result) => {
                if (result.isConfirmed) {
                    toggleLoading(true);
                    await fetchGAS({ action: 'delete_data', table: tableName, id: id });
                    const refresh = await fetchGAS({ action: 'get_data', nik: currentUser.nik });
                    appData = refresh.data;
                    toggleLoading(false);
                    Swal.fire('Terhapus', 'Berhasil', 'success');
                    document.querySelector('.nav-link.active').click();
                }
            });
        }

        async function addData(tableName) {
            let htmlForm = '';
            if (tableName === 'tb_pangkat') htmlForm = `<input id="f-gol" class="swal2-input" placeholder="Golongan"><input id="f-pangkat" class="swal2-input" placeholder="Nama Pangkat"><input id="f-nosk" class="swal2-input" placeholder="No SK"><label>Tgl SK</label><input type="date" id="f-tglsk" class="swal2-input"><label>TMT</label><input type="date" id="f-tmt" class="swal2-input"><div class="mt-3"><input type="file" id="f-file" class="form-control"></div>`;
            else if (tableName === 'tb_keluarga') htmlForm = `<input id="f-nama" class="swal2-input" placeholder="Nama"><input id="f-nik" class="swal2-input" placeholder="NIK Anggota"><select id="f-hub" class="swal2-select"><option>Suami</option><option>Istri</option><option>Anak</option></select><select id="f-jk" class="swal2-select"><option value="L">L</option><option value="P">P</option></select><label>Tgl Lahir</label><input type="date" id="f-tgl" class="swal2-input"><select id="f-tunj" class="swal2-select"><option value="Ya">Dapat Tunjangan</option><option value="Tidak">Tidak</option></select>`;
            else if (tableName === 'tb_jabatan') htmlForm = `<input id="f-nama" class="swal2-input" placeholder="Nama Jabatan"><select id="f-jenis" class="swal2-select"><option>Struktural</option><option>Fungsional</option></select><input id="f-eselon" class="swal2-input" placeholder="Eselon"><input id="f-unit" class="swal2-input" placeholder="Unit Kerja"><input id="f-nosk" class="swal2-input" placeholder="No SK"><label>TMT</label><input type="date" id="f-tmt" class="swal2-input"><div class="mt-3"><input type="file" id="f-file" class="form-control"></div>`;
            else if (tableName === 'tb_kartu') htmlForm = `<select id="f-jenis" class="swal2-select"><option>BPJS</option><option>NPWP</option><option>Karpeg</option></select><input id="f-nomor" class="swal2-input" placeholder="Nomor Kartu"><div class="mt-3"><input type="file" id="f-file" class="form-control"></div>`;

            const { value: formValues } = await Swal.fire({ title: 'Tambah Data', html: htmlForm, showCancelButton: true, preConfirm: async () => {
                if (!htmlForm) return null;
                let fileUrl = ''; const fileInput = document.getElementById('f-file');
                if (fileInput && fileInput.files[0]) {
                    const base64 = await toBase64(fileInput.files[0]);
                    const upRes = await fetchGAS({ action: 'upload_file', base64: base64.split(',')[1], mimeType: fileInput.files[0].type, nik: currentUser.nik, type: 'DOC' });
                    if (upRes.status === 'success') fileUrl = upRes.url;
                }
                if (tableName === 'tb_pangkat') return { Golongan: document.getElementById('f-gol').value, Pangkat: document.getElementById('f-pangkat').value, No_SK: document.getElementById('f-nosk').value, Tgl_SK: document.getElementById('f-tglsk').value, TMT: document.getElementById('f-tmt').value, Link_File: fileUrl };
                else if (tableName === 'tb_keluarga') return { Nama: document.getElementById('f-nama').value, NIK_Anggota: document.getElementById('f-nik').value, Hubungan: document.getElementById('f-hub').value, JK: document.getElementById('f-jk').value, Tgl_Lahir: document.getElementById('f-tgl').value, Tunjangan: document.getElementById('f-tunj').value };
                else if (tableName === 'tb_jabatan') return { Nama_Jabatan: document.getElementById('f-nama').value, Jenis_Jabatan: document.getElementById('f-jenis').value, Eselon: document.getElementById('f-eselon').value, Unit_Kerja: document.getElementById('f-unit').value, No_SK: document.getElementById('f-nosk').value, TMT: document.getElementById('f-tmt').value, Link_File: fileUrl };
                else if (tableName === 'tb_kartu') return { Jenis_Kartu: document.getElementById('f-jenis').value, No_Kartu: document.getElementById('f-nomor').value, Link_File: fileUrl };
                return {};
            }});
            if (formValues) saveData(tableName, formValues);
        }

        async function fetchGAS(payload) { const response = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) }); return await response.json(); }
        const sessUser = sessionStorage.getItem('simpeg_user'); if (sessUser) { currentUser = JSON.parse(sessUser); initApp(); }
    </script>
</body>
</html>
