<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMPEG RSUD dr. R. Koesma</title>
    <!-- Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts: Poppins for elegance -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        /* --- THEME CONFIGURATION: ORANGE GLASS BATIK --- */
        :root { 
            --primary: #c2410c;       /* Orange 700 */
            --primary-dark: #7c2d12;  /* Orange 900 */
            --primary-light: #fb923c; /* Orange 400 */
            --accent: #ffedd5;        /* Orange 100 */
            
            /* Glassmorphism Variables */
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: 1px solid rgba(255, 255, 255, 0.3);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            --text-on-glass: #ffffff;
            --text-muted-on-glass: #ffedd5; 
        }
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background: #fff7ed; /* Very light orange fallback */
            color: #333;
            overflow-x: hidden;
        }
        
        /* --- LAYOUT SIDEBAR (Glass Effect) --- */
        .sidebar { 
            min-height: 100vh; width: 260px; 
            background: linear-gradient(180deg, var(--primary-dark) 0%, var(--primary) 100%);
            color: white; 
            position: fixed; transition: all 0.3s; z-index: 1050; 
            left: 0; 
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
        }
        .sidebar.collapsed { left: -260px; } 

        .sidebar .nav-link { 
            color: rgba(255,255,255,0.85); 
            margin: 4px 12px; /* Adjusted margin */
            padding: 10px 15px; /* Adjusted padding */
            border-radius: 10px; 
            font-weight: 500; 
            cursor: pointer; 
            position: relative; 
            z-index: 1051;
            transition: all 0.3s ease;
            font-size: 0.85rem; /* PERBAIKAN: Font diperkecil */
            white-space: nowrap; /* PERBAIKAN: Memaksa 1 baris */
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { 
            background: rgba(255, 255, 255, 0.2); 
            color: #fff; 
            transform: translateX(5px); 
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .sidebar .nav-link i { width: 20px; text-align: center; margin-right: 8px; }
        
        .main-content { margin-left: 260px; padding: 25px; transition: all 0.3s; }
        .main-content.expanded { margin-left: 0; }
        
        /* Mobile Overlay */
        .sidebar-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); z-index: 1040;
        }
        .sidebar-overlay.active { display: block; }

        @media (max-width: 768px) {
            .sidebar { left: -260px; } 
            .sidebar.active { left: 0; }
            .sidebar.collapsed { left: -260px; }
            .main-content { margin-left: 0; }
            .main-content.expanded { margin-left: 0; }
        }

        /* --- SWEETALERT2 CUSTOMIZATION (Orange Theme) --- */
        .swal2-popup { font-size: 0.9rem !important; border-radius: 15px !important; padding: 1.5em !important; border-top: 5px solid var(--primary); }
        .swal2-title { font-size: 1.4rem !important; font-weight: 700 !important; color: var(--primary-dark) !important; }
        .swal2-confirm { background-color: var(--primary) !important; box-shadow: 0 4px 6px rgba(194, 65, 12, 0.4) !important; }
        .swal-form-group { text-align: left; margin-bottom: 1rem; }
        .swal-form-label { font-weight: 600; font-size: 0.85rem; margin-bottom: 0.4rem; display: block; color: var(--primary-dark); }

        /* --- COMPONENTS --- */
        .card { border: none; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); transition: transform 0.2s; background: #fff; }
        
        /* Badges */
        .status-badge-DRAFT { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; padding: 5px 12px; border-radius: 20px; font-size: 0.75em; font-weight: 700; letter-spacing: 0.5px; }
        .status-badge-VERIFIED { background: #ecfdf5; color: #047857; border: 1px solid #d1fae5; padding: 5px 12px; border-radius: 20px; font-size: 0.75em; font-weight: 700; letter-spacing: 0.5px; }
        
        /* Loading */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.85); backdrop-filter: blur(5px); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .spinner-custom { color: var(--primary); }

        /* Tables */
        .table-admin th { background-color: #fff7ed; color: var(--primary-dark); font-size: 0.85rem; text-transform: uppercase; font-weight: 700; border-bottom: 2px solid var(--primary-light); }
        .table-admin td { font-size: 0.85rem; }

        /* Tabs */
        .nav-tabs .nav-link { cursor: pointer; color: #64748b; font-weight: 500; border: none; background: transparent; transition: 0.2s; }
        .nav-tabs .nav-link:hover { color: var(--primary); }
        .nav-tabs .nav-link.active { color: var(--primary); font-weight: 700; border-bottom: 3px solid var(--primary); background: transparent; }
        
        /* Pagination */
        .page-link { color: var(--primary); border: none; background: transparent; font-weight: 600; }
        .page-link:hover { color: var(--primary-dark); background: #fff7ed; }
        .page-item.active .page-link { background-color: var(--primary); border-color: var(--primary); color: white; border-radius: 5px; }
        .page-item.disabled .page-link { color: #ccc; }

        /* --- LOGIN STYLING (ORANGE GLASS BATIK) --- */
        .login-wrapper { 
            min-height: 100vh; 
            background-color: var(--primary-dark);
            background-image: 
                linear-gradient(135deg, rgba(124, 45, 18, 0.9) 0%, rgba(251, 146, 60, 0.8) 100%),
                url("https://www.transparenttextures.com/patterns/batik.png"); 
            background-size: cover, auto;
            background-blend-mode: multiply;
            display: flex; align-items: center; justify-content: center; padding: 20px; 
        }

        .login-card-modern { 
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: 24px; 
            width: 100%; max-width: 420px; 
            padding: 45px; 
            position: relative; 
            overflow: hidden; 
            color: var(--text-on-glass);
        }
        
        .login-card-modern::before { 
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px; 
            background: linear-gradient(90deg, #fb923c, #c2410c); 
        }

        .login-header { text-align: center; margin-bottom: 35px; }
        .login-header img { width: 90px; margin-bottom: 15px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; padding: 5px; background: rgba(255,255,255,0.1); filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); }
        .login-header h4 { font-weight: 700; color: #fff; letter-spacing: 1px; margin-bottom: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .login-header p { color: var(--text-muted-on-glass); font-size: 0.9rem; font-weight: 300; }
        
        .form-modern .form-label { font-size: 0.85rem; font-weight: 600; color: #fff7ed; margin-left: 4px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .form-modern .form-control { 
            padding: 12px 18px; 
            border-radius: 12px; 
            border: 1px solid rgba(255,255,255,0.3); 
            background-color: rgba(255, 255, 255, 0.9); 
            font-size: 0.95rem; 
            transition: all 0.3s ease; 
            color: #7c2d12;
        }
        .form-modern .form-control:focus { 
            background-color: #fff; 
            border-color: #fb923c; 
            box-shadow: 0 0 0 4px rgba(251, 146, 60, 0.3); 
            outline: none;
        }
        .form-modern .form-control::placeholder { color: #9ca3af; }

        .btn-primary-modern { 
            background: linear-gradient(135deg, #fb923c, #c2410c); 
            border: none; color: white; padding: 14px; border-radius: 12px; font-weight: 600; letter-spacing: 0.5px; width: 100%; margin-top: 15px; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .btn-primary-modern:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 10px 15px rgba(124, 45, 18, 0.4); 
            color: white;
            background: linear-gradient(135deg, #fdba74, #ea580c); 
        }

        .auth-separator { display: flex; align-items: center; text-align: center; color: rgba(255,255,255,0.5); margin: 25px 0; font-size: 0.75rem; font-weight: 500; letter-spacing: 1px; }
        .auth-separator::before, .auth-separator::after { content: ''; flex: 1; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .auth-separator span { padding: 0 10px; }
        
        .auth-footer { text-align: center; margin-top: 25px; font-size: 0.9rem; color: var(--text-muted-on-glass); }
        .auth-footer a { color: #fff; font-weight: 700; text-decoration: none; cursor: pointer; border-bottom: 1px dashed rgba(255,255,255,0.5); transition: all 0.2s; }
        .auth-footer a:hover { color: #fff7ed; border-bottom-color: #fff7ed; }

        .animate-fade { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div class="spinner-border spinner-custom" style="width: 3rem; height: 3rem;"></div>
        <h5 class="mt-3 spinner-custom fw-bold">Memproses Data...</h5>
    </div>

    <!-- LOGIN SECTION -->
    <div id="app-login" class="login-wrapper">
        <div class="login-card-modern animate-fade">
            <div class="login-header">
                <img src="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png" alt="Logo RSUD">
                <h4>SIMPEG KOESMA</h4>
                <p>Sistem Informasi Kepegawaian <br>RSUD dr. R. Koesma Tuban</p>
            </div>

            <!-- VIEW: LOGIN FORM -->
            <div id="view-auth-login">
                <form onsubmit="handleLogin(event)" class="form-modern">
                    <div class="mb-3">
                        <label class="form-label">NIK atau Email</label>
                        <input type="text" id="l-identifier" class="form-control" placeholder="Masukkan NIK atau Email" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Kata Sandi</label>
                        <div class="position-relative">
                            <input type="password" id="l-pass" class="form-control" placeholder="••••••••" required style="padding-right: 45px;">
                            <span class="position-absolute top-50 end-0 translate-middle-y me-3" onclick="togglePassword('l-pass', this)" style="cursor: pointer; color: var(--primary);">
                                <i class="fas fa-eye"></i>
                            </span>
                        </div>
                    </div>
                    <div class="text-end mb-4"><a href="#" onclick="forgotPassword()" class="text-decoration-none small text-white opacity-75 hover-opacity-100">Lupa Password?</a></div>
                    <button type="submit" class="btn-primary-modern">MASUK APLIKASI</button>
                </form>
                <div class="auth-separator"><span>ATAU</span></div>
                <div class="d-flex justify-content-center">
                    <div id="g_id_onload" data-client_id="783459415718-mp0vsmd2lopajf2ut0aqc6drjrs95pu8.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_prompt="false"></div>
                    <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="outline" data-text="signin_with" data-size="large" data-logo_alignment="left" data-width="340"></div>
                </div>
                <div class="auth-footer">Belum memiliki akun? <a onclick="switchAuthMode('register')">Daftar sekarang</a></div>
            </div>

            <!-- VIEW: REGISTER FORM -->
            <div id="view-auth-register" class="d-none">
                <form onsubmit="handleRegister(event)" class="form-modern">
                    <div class="mb-3"><label class="form-label">NIK (Sesuai KTP)</label><input type="number" id="r-nik" class="form-control" placeholder="16 Digit NIK" required minlength="16"></div>
                    <div class="mb-3"><label class="form-label">Nama Lengkap</label><input type="text" id="r-nama" class="form-control" placeholder="Nama Lengkap Tanpa Gelar" required></div>
                    <div class="mb-3"><label class="form-label">Email (Wajib / Gmail)</label><input type="email" id="r-email" class="form-control" placeholder="contoh@gmail.com" required><div class="text-white opacity-75 small mt-1" style="font-size: 0.75rem;">Digunakan untuk login & reset password.</div></div>
                    
                    <div class="mb-4">
                        <label class="form-label">Buat Kata Sandi</label>
                        <div class="position-relative">
                            <input type="password" id="r-pass" class="form-control" placeholder="Min. 6 Karakter" required minlength="6" style="padding-right: 45px;">
                            <span class="position-absolute top-50 end-0 translate-middle-y me-3" onclick="togglePassword('r-pass', this)" style="cursor: pointer; color: var(--primary);">
                                <i class="fas fa-eye"></i>
                            </span>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary-modern">DAFTAR AKUN</button>
                </form>
                <div class="auth-footer">Sudah punya akun? <a onclick="switchAuthMode('login')">Masuk disini</a></div>
            </div>
        </div>
    </div>

    <!-- MAIN APP SECTION -->
    <div id="app-main" class="d-none">
        
        <!-- Overlay -->
        <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <div class="sidebar d-flex flex-column p-3" id="sidebar">
            <div class="d-flex justify-content-between align-items-center mb-4 text-white">
                <div class="text-center w-100">
                    <img src="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png" width="50" class="bg-white rounded-circle p-1 mb-2 shadow-sm">
                    <h6 class="fw-bold mb-0 text-white" style="letter-spacing: 1px;">SIMPEG KOESMA</h6>
                    <small id="user-display-name" class="text-white-50">User</small>
                </div>
                <!-- Tombol Close Sidebar (Mobile Only) -->
                <button class="btn btn-sm text-white d-md-none position-absolute top-0 end-0 m-3" onclick="toggleSidebar()">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            
            <ul class="nav flex-column mb-auto">
                <li class="nav-item"><a class="nav-link active" onclick="navTo('profil')" style="cursor: pointer;"><i class="fas fa-user-circle me-2"></i> Profil Pegawai</a></li>
                <li class="nav-item"><a class="nav-link" onclick="navTo('pangkat')" style="cursor: pointer;"><i class="fas fa-medal me-2"></i> Riwayat Pangkat</a></li>
                <li class="nav-item"><a class="nav-link" onclick="navTo('jabatan')" style="cursor: pointer;"><i class="fas fa-briefcase me-2"></i> Riwayat Jabatan</a></li>
                <li class="nav-item"><a class="nav-link" onclick="navTo('keluarga')" style="cursor: pointer;"><i class="fas fa-users me-2"></i> Anggota Keluarga</a></li>
                <li class="nav-item"><a class="nav-link" onclick="navTo('kartu')" style="cursor: pointer;"><i class="fas fa-id-card me-2"></i> Data Kartu</a></li>
                <li class="nav-item d-none" id="menu-admin"><a class="nav-link bg-white text-danger mt-3 shadow-sm" onclick="navTo('admin')" style="color: var(--primary) !important; cursor: pointer;"><i class="fas fa-user-shield me-2"></i> Admin Dashboard</a></li>
            </ul>
            <div class="mt-auto"><button onclick="logout()" class="btn btn-outline-light w-100"><i class="fas fa-sign-out-alt me-2"></i> Logout</button></div>
        </div>

        <!-- Content -->
        <div class="main-content" id="main-content">
            <!-- Toggle Button (Visible on both PC & Mobile) -->
            <button class="btn text-white mb-3 shadow-sm" onclick="toggleSidebar()" style="background-color: var(--primary); border: none;">
                <i class="fas fa-bars"></i> Menu
            </button>
            <div id="view-container"></div>
        </div>
    </div>

    <!-- Javascript Logic -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwgNdoZPiFJNdbM8tBmx1lGwonOj92sI8fgYUvEjR_x2Q-nwq9z_vkTq1MqMZG1MTAO/exec'; 
        let currentUser = null;
        let appData = {}; 
        let adminData = {}; 
        let selectedIds = []; 
        
        // --- PAGINATION STATE ---
        let currentAdminPage = 1;
        let adminSearchTimer = null;

        function toggleLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }
        
        function toggleSidebar() { 
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const mainContent = document.getElementById('main-content');
            
            if (window.innerWidth > 768) {
                // PC: Toggle Collapse class
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('expanded');
            } else {
                // Mobile: Toggle Overlay
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            }
        }

        function togglePassword(inputId, trigger) {
            const input = document.getElementById(inputId); const icon = trigger.querySelector('i');
            if (input.type === "password") { input.type = "text"; icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); } 
            else { input.type = "password"; icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye'); }
        }

        function getImgUrl(url) { if (!url || url.length < 5) return 'https://via.placeholder.com/150'; if (url.includes('drive.google.com/file/d/')) { try { const id = url.split('/d/')[1].split('/')[0]; return `https://lh3.googleusercontent.com/d/${id}`; } catch(e) { return url; } } return url; }
        function toBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); }); }
        function formatDateDisplay(d) { if(!d) return '-'; const date = new Date(d); if(isNaN(date.getTime())) return d; const day = String(date.getDate()).padStart(2, '0'); const month = String(date.getMonth() + 1).padStart(2, '0'); const year = date.getFullYear(); return `${day}-${month}-${year}`; }
        function switchAuthMode(mode) { const l=document.getElementById('view-auth-login'), r=document.getElementById('view-auth-register'); if(mode==='register'){l.classList.add('d-none');r.classList.remove('d-none');r.classList.add('animate-fade')}else{r.classList.add('d-none');l.classList.remove('d-none');l.classList.add('animate-fade')} }

        // --- AUTH API CALLS ---
        async function handleLogin(e) { e.preventDefault(); const i=document.getElementById('l-identifier').value, p=document.getElementById('l-pass').value; toggleLoading(true); const r=await fetchGAS({action:'login',identifier:i,password:p}); toggleLoading(false); if(r.status==='success') loginSuccess(r.user); else Swal.fire('Gagal',r.message,'error'); }
        async function handleRegister(e) { e.preventDefault(); const n=document.getElementById('r-nik').value, nm=document.getElementById('r-nama').value, em=document.getElementById('r-email').value, p=document.getElementById('r-pass').value; if(!em){Swal.fire('Error','Email wajib','warning');return} if(!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,}$/.test(p)){Swal.fire('Lemah','Min 6 karakter (huruf+angka)','warning');return} toggleLoading(true); const r=await fetchGAS({action:'register',nik:n,nama:nm,email:em,password:p}); toggleLoading(false); if(r.status==='success'){Swal.fire('Berhasil','Akun dibuat.','success');switchAuthMode('login')}else Swal.fire('Gagal',r.message,'error'); }
        function handleCredentialResponse(r) { const p=JSON.parse(atob(r.credential.split('.')[1])); toggleLoading(true); fetchGAS({action:'google_login',email:p.email}).then(res=>{toggleLoading(false); if(res.status==='success')loginSuccess(res.user); else Swal.fire('Gagal',res.message,'error')}); }
        async function forgotPassword() { const {value:i}=await Swal.fire({title:'Reset Password',input:'text',inputPlaceholder:'NIK/Email',showCancelButton:true,confirmButtonText:'Kirim',showLoaderOnConfirm:true,preConfirm:async(v)=>{try{const r=await fetchGAS({action:'forgot_password',identifier:v});if(r.status!=='success')throw new Error(r.message);return r.message}catch(e){Swal.showValidationMessage(e.message)}}}); if(i)Swal.fire('Terkirim!',i,'success'); }
        async function changePassword() { const {value:v}=await Swal.fire({title:'Ubah Password',html:'<div class="swal-form-group"><label class="swal-form-label">Password Lama</label><input type="password" id="old-pass" class="form-control"></div><div class="swal-form-group"><label class="swal-form-label">Password Baru</label><input type="password" id="new-pass" class="form-control"></div>',showCancelButton:true,confirmButtonText:'Ubah',preConfirm:async()=>{const o=document.getElementById('old-pass').value,n=document.getElementById('new-pass').value; if(!o||!n){Swal.showValidationMessage('Isi semua field');return false} if(n.length<6){Swal.showValidationMessage('Min 6 karakter');return false} try{const r=await fetchGAS({action:'change_password',nik:currentUser.nik,oldPass:o,newPass:n});if(r.status!=='success')throw new Error(r.message);return r.message}catch(e){Swal.showValidationMessage(e.message)}}}); if(v)Swal.fire('Sukses',v,'success'); }

        function loginSuccess(u) { currentUser=u; sessionStorage.setItem('simpeg_user',JSON.stringify(u)); if(window.location.hash==='#admin'&&u.role!=='ADMIN'){Swal.fire('Akses Ditolak','Bukan Admin','warning');window.location.hash=''} initApp(); }
        function logout() { sessionStorage.removeItem('simpeg_user'); window.location.reload(); }

        // --- APP INIT & ROUTING ---
        async function initApp() { 
            document.getElementById('app-login').classList.add('d-none'); 
            document.getElementById('app-main').classList.remove('d-none'); 
            
            // Set nama sementara dari session storage
            document.getElementById('user-display-name').innerText = currentUser.nama; 
            
            if(currentUser.role==='ADMIN')document.getElementById('menu-admin').classList.remove('d-none'); 
            
            toggleLoading(true); 
            const r=await fetchGAS({action:'get_data',nik:currentUser.nik}); 
            toggleLoading(false); 
            
            if(r.status==='success'){
                appData=r.data; 
                
                // Update Navbar Name with Profile Data if available
                if (appData.profil && appData.profil.Nama) {
                     document.getElementById('user-display-name').innerText = appData.profil.Nama;
                }
                
                processCurrentHash();
            } 
        }

        // [ROUTER LOGIC]
        function processCurrentHash() {
            let hash = window.location.hash.substring(1); 
            if(!hash) hash = 'profil';
            if (hash === 'riwayatjabatan') hash = 'jabatan';
            else if (hash === 'riwayatpangkat') hash = 'pangkat';
            else if (hash === 'anggotakeluarga') hash = 'keluarga';
            else if (hash === 'datakartu') hash = 'kartu';
            if (hash === 'admin' && currentUser.role !== 'ADMIN') hash = 'profil';
            renderPage(hash);
        }
        
        window.addEventListener('hashchange', processCurrentHash);

        function navTo(page) {
            // UI Sidebar Handling: Auto close on mobile
            if (window.innerWidth <= 768) { 
                document.getElementById('sidebar').classList.remove('active'); 
                document.getElementById('sidebar-overlay').classList.remove('active'); 
            }
            
            // Generate URL Hash
            let urlHash = page;
            if (page === 'jabatan') urlHash = 'riwayatjabatan';
            else if (page === 'pangkat') urlHash = 'riwayatpangkat';
            else if (page === 'keluarga') urlHash = 'anggotakeluarga';
            else if (page === 'kartu') urlHash = 'datakartu';

            // Set Hash (Triggers hashchange -> processCurrentHash -> renderPage)
            window.location.hash = urlHash;
        }

        function renderPage(page) {
            document.querySelectorAll('.nav-link').forEach(e=>e.classList.remove('active'));
            let menuKey = page; // fallback
            if(page==='pangkat') menuKey='pangkat'; 
            else if(page==='jabatan') menuKey='jabatan';
            const menu = document.querySelector(`[onclick="navTo('${menuKey}')"]`);
            if(menu) menu.classList.add('active');
            
            const container = document.getElementById('view-container');
            if(page==='profil') renderProfil(container);
            else if(page==='pangkat') renderTable(container,'Riwayat Pangkat','tb_pangkat');
            else if(page==='jabatan') renderTable(container,'Riwayat Jabatan','tb_jabatan');
            else if(page==='keluarga') renderTable(container,'Anggota Keluarga','tb_keluarga');
            else if(page==='kartu') renderTable(container,'Data Kartu Identitas','tb_kartu');
            else if(page==='admin') renderAdminDashboardV2(container);
        }

        function renderTable(c,t,tn) { 
            const d = appData[tn] || []; 
            let h=''; 
            if(d.length > 0) {
                d.forEach((i,x)=>{ 
                    const b = i.Status_Verifikasi === 'VERIFIED' ? 'success' : 'warning'; 
                    const f = i.Link_File ? `<a href="${i.Link_File}" target="_blank" class="btn btn-sm btn-info me-1"><i class="fas fa-file"></i></a>` : ''; 
                    h += `<tr><td>${x+1}</td><td><b>${Object.values(i)[2]||'-'}</b><br>${Object.values(i)[3]||'-'}</td><td>${i.TMT||i.Tunjangan||'-'}</td><td><span class="badge bg-${b}">${i.Status_Verifikasi}</span></td><td>${f}<button onclick="deleteData('${tn}','${i.ID}')" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button></td></tr>`;
                }); 
            } else {
                h = '<tr><td colspan="5" class="text-center p-4">Belum ada data.</td></tr>'; 
            }
            c.innerHTML=`<div class="card p-4"><div class="d-flex justify-content-between mb-4"><h4 class="text-primary fw-bold text-capitalize">${t}</h4><button onclick="addData('${tn}')" class="btn btn-primary"><i class="fas fa-plus"></i> Tambah</button></div><div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>No</th><th>Detail</th><th>Ket</th><th>Status</th><th>Aksi</th></tr></thead><tbody>${h}</tbody></table></div></div>`; 
        }

        // ... (Functions addData, saveData, deleteData same as before) ...
        function renderProfil(c) { 
            const p=appData.profil||{}; 
            const url=getImgUrl(p.Foto_Profil); 
            const l=currentUser.email_login?.toLowerCase().trim(); 
            const pe=p.Email?.toLowerCase().trim(); 
            const en= (pe&&l&&pe===l) ? '<span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25" style="font-size:0.7em"><i class="fas fa-check-circle"></i> Login OK</span>' : '<span class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25" style="font-size:0.7em"><i class="fas fa-info-circle"></i> Kontak Saja</span>'; 
            const ft=formatDateDisplay(p.Tgl_Lahir);
            
            c.innerHTML=`<div class="card p-4"><div class="d-flex justify-content-between mb-4 border-bottom pb-3"><h4 class="fw-bold text-primary mb-0">Profil Pegawai</h4><div><span class="badge bg-${p.Status_Verifikasi==='VERIFIED'?'success':'warning'}">${p.Status_Verifikasi||'DRAFT'}</span><button onclick="editProfil()" class="btn btn-sm btn-primary ms-1"><i class="fas fa-edit"></i> Edit</button><button onclick="changePassword()" class="btn btn-sm btn-warning ms-1"><i class="fas fa-key"></i> Pass</button></div></div><div class="row"><div class="col-md-3 text-center mb-3"><img src="${url}" class="img-thumbnail rounded-circle mb-2" style="width:150px;height:150px;object-fit:cover"><h5 class="fw-bold">${p.Nama||'Nama Pegawai'}</h5><p class="text-muted">${p.NIP||'-'}</p></div><div class="col-md-9"><div class="row g-3"><div class="col-md-6"><label class="small text-muted">NIK</label><p class="fw-bold">${p.NIK||'-'}</p></div><div class="col-md-6"><label class="small text-muted">NIP</label><p class="fw-bold">${p.NIP||'-'}</p></div><div class="col-md-6"><label class="small text-muted">Tgl Lahir</label><p class="fw-bold">${p.Tmp_Lahir||''}, ${ft}</p></div><div class="col-md-6"><label class="small text-muted">JK</label><p class="fw-bold">${p.JK||'-'}</p></div><div class="col-md-6"><label class="small text-muted">Email Kontak</label><p class="fw-bold mb-1">${p.Email||'-'}</p>${en}</div><div class="col-md-6"><label class="small text-muted">HP</label><p class="fw-bold">${p.No_HP||'-'}</p></div><div class="col-md-12"><label class="small text-muted">Alamat</label><p class="fw-bold">${p.Alamat||'-'}</p></div><div class="col-md-6"><label class="small text-muted">Pendidikan</label><p class="fw-bold">${p.Pendidikan||'-'}</p></div><div class="col-md-6"><label class="small text-muted">Jabatan</label><p class="fw-bold">${p.Jabatan_Terakhir||'-'}</p></div><div class="col-md-6"><label class="small text-muted">Status Kepegawaian</label><p class="fw-bold">${p.Status_Peg||'-'}</p></div></div></div></div></div>`; 
        }
        
        async function editProfil() { 
            const p = appData.profil || {}; 
            const standardStatus = ['PNS', 'PPPK', 'Tenaga Kegiatan'];
            let isStandard = standardStatus.includes(p.Status_Peg);
            let selectVal = isStandard ? p.Status_Peg : (p.Status_Peg ? 'Lainnya' : 'PNS'); // Default to PNS if empty, or Lainnya if custom
            let otherVal = isStandard ? '' : p.Status_Peg;
            let otherDisplay = selectVal === 'Lainnya' ? 'block' : 'none';

            try {
                const { value: formValues } = await Swal.fire({
                    title: 'Edit Profil', 
                    width: '600px', 
                    showCancelButton: true, 
                    confirmButtonText: 'Simpan',
                    html: `
                        <div class="swal-form-group"><label class="swal-form-label">NIK (KTP) <span class="text-danger">*Kunci Data</span></label><input id="sw-real-nik" class="form-control bg-light" value="${p.NIK||''}" readonly></div>
                        <div class="swal-form-group"><label class="swal-form-label">NIP (Nomor Induk Pegawai)</label><input id="sw-nip" class="form-control" placeholder="Masukkan NIP Baru" value="${p.NIP||''}"></div>
                        <div class="swal-form-group"><label class="swal-form-label">Nama Lengkap</label><input id="sw-nama" class="form-control" value="${p.Nama||''}"></div>
                        <div class="d-flex gap-2 mb-2"><div class="w-50"><input id="sw-tmp" class="form-control" placeholder="Tmp Lahir" value="${p.Tmp_Lahir||''}"></div><div class="w-50"><input id="sw-tgl" class="form-control" type="date" value="${p.Tgl_Lahir||''}"></div></div>
                        <div class="swal-form-group"><label class="swal-form-label">Jenis Kelamin</label><select id="sw-jk" class="form-select"><option value="L" ${p.JK=='L'?'selected':''}>Laki-laki</option><option value="P" ${p.JK=='P'?'selected':''}>Perempuan</option></select></div>
                        <div class="swal-form-group"><label class="swal-form-label">Status Kepegawaian</label>
                            <select id="sw-status" class="form-select" onchange="document.getElementById('div-status-other').style.display = this.value === 'Lainnya' ? 'block' : 'none'">
                                <option value="PNS" ${selectVal==='PNS'?'selected':''}>PNS</option>
                                <option value="PPPK" ${selectVal==='PPPK'?'selected':''}>PPPK</option>
                                <option value="Tenaga Kegiatan" ${selectVal==='Tenaga Kegiatan'?'selected':''}>Tenaga Kegiatan</option>
                                <option value="Lainnya" ${selectVal==='Lainnya'?'selected':''}>Lainnya</option>
                            </select>
                        </div>
                        <div id="div-status-other" class="swal-form-group" style="display:${otherDisplay};"><input id="sw-status-other" class="form-control" placeholder="Tulis Status..." value="${otherVal||''}"></div>
                        <div class="swal-form-group"><label class="swal-form-label">Email Kontak</label><input id="sw-email" class="form-control" value="${p.Email||''}"><small class="text-muted" style="font-size:0.75rem">*Tidak mengubah email login.</small></div>
                        <div class="swal-form-group"><label class="swal-form-label">HP</label><input id="sw-hp" class="form-control" value="${p.No_HP||''}"></div>
                        <div class="swal-form-group"><label class="swal-form-label">Alamat</label><input id="sw-alamat" class="form-control" value="${p.Alamat||''}"></div>
                        <div class="swal-form-group"><label class="swal-form-label">Pendidikan</label><input id="sw-pend" class="form-control" value="${p.Pendidikan||''}"></div>
                        <div class="swal-form-group"><label class="swal-form-label">Jabatan</label><input id="sw-jab" class="form-control" value="${p.Jabatan_Terakhir||''}"></div>
                        <div class="swal-form-group"><label class="swal-form-label">Foto Profil</label><input type="file" id="sw-foto" class="form-control"></div>
                    `,
                    preConfirm: async () => {
                        const fileInput = document.getElementById('sw-foto').files[0];
                        let fotoUrl = p.Foto_Profil;
                        if (fileInput) { const base64 = await toBase64(fileInput); const upRes = await fetchGAS({ action: 'upload_file', base64: base64.split(',')[1], mimeType: fileInput.type, nik: currentUser.nik, type: 'FOTO' }); if(upRes.status === 'success') fotoUrl = upRes.url; }
                        
                        let statusPeg = document.getElementById('sw-status').value;
                        if(statusPeg === 'Lainnya') statusPeg = document.getElementById('sw-status-other').value;

                        return { NIP: document.getElementById('sw-nip').value, Nama: document.getElementById('sw-nama').value, Tmp_Lahir: document.getElementById('sw-tmp').value, Tgl_Lahir: document.getElementById('sw-tgl').value, JK: document.getElementById('sw-jk').value, Status_Peg: statusPeg, Email: document.getElementById('sw-email').value, No_HP: document.getElementById('sw-hp').value, Alamat: document.getElementById('sw-alamat').value, Pendidikan: document.getElementById('sw-pend').value, Jabatan_Terakhir: document.getElementById('sw-jab').value, Foto_Profil: fotoUrl };
                    }
                });
                if (formValues) saveData('tb_profil', formValues);
            } catch (err) { console.error(err); Swal.fire('Error', 'Terjadi kesalahan.', 'error'); }
        }

        async function addData(tn) {
            let htmlForm = '';
            // [UPDATED FORM STRUCTURE]
            if (tn === 'tb_pangkat') {
                htmlForm = `
                    <div class="swal-form-group"><label class="swal-form-label">Golongan</label><input id="f-1" class="form-control" placeholder="Contoh: III/a"></div>
                    <div class="swal-form-group"><label class="swal-form-label">Pangkat</label><input id="f-2" class="form-control" placeholder="Nama Pangkat"></div>
                    <div class="swal-form-group"><label class="swal-form-label">No SK</label><input id="f-3" class="form-control"></div>
                    <div class="swal-form-group"><label class="swal-form-label">Tgl SK</label><input type="date" id="f-4" class="form-control"></div>
                    <div class="swal-form-group"><label class="swal-form-label">TMT</label><input type="date" id="f-5" class="form-control"></div>
                    <div class="swal-form-group"><label class="swal-form-label">File SK</label><input type="file" id="f-f" class="form-control"></div>`;
            } else if (tn === 'tb_keluarga') {
                htmlForm = `
                    <div class="swal-form-group"><label class="swal-form-label">Nama</label><input id="f-1" class="form-control"></div>
                    <div class="swal-form-group"><label class="swal-form-label">NIK</label><input id="f-2" class="form-control"></div>
                    <div class="swal-form-group"><label class="swal-form-label">Hubungan</label><select id="f-3" class="form-select"><option>Suami</option><option>Istri</option><option>Anak</option></select></div>
                    <div class="swal-form-group"><label class="swal-form-label">JK</label><select id="f-4" class="form-select"><option value="L">L</option><option value="P">P</option></select></div>
                    <div class="swal-form-group"><label class="swal-form-label">Tgl Lahir</label><input type="date" id="f-5" class="form-control"></div>
                    <div class="swal-form-group"><label class="swal-form-label">Tunjangan</label><select id="f-6" class="form-select"><option>Ya</option><option>Tidak</option></select></div>`;
            } else if (tn === 'tb_jabatan') {
                htmlForm = `
                    <div class="swal-form-group"><label class="swal-form-label">Jabatan</label><input id="f-1" class="form-control"></div>
                    <div class="swal-form-group"><label class="swal-form-label">Jenis</label><select id="f-2" class="form-select"><option>Struktural</option><option>Fungsional</option></select></div>
                    <div class="swal-form-group"><label class="swal-form-label">Eselon</label><input id="f-3" class="form-control"></div>
                    <div class="swal-form-group"><label class="swal-form-label">Unit</label><input id="f-4" class="form-control"></div>
                    <div class="swal-form-group"><label class="swal-form-label">No SK</label><input id="f-5" class="form-control"></div>
                    <div class="swal-form-group"><label class="swal-form-label">TMT</label><input type="date" id="f-6" class="form-control"></div>
                    <div class="swal-form-group"><label class="swal-form-label">File SK</label><input type="file" id="f-f" class="form-control"></div>`;
            } else if (tn === 'tb_kartu') {
                htmlForm = `
                    <div class="swal-form-group">
                        <label class="swal-form-label">Jenis Kartu</label>
                        <select id="f-1" class="form-select" onchange="document.getElementById('div-other').style.display = this.value === 'Lainnya' ? 'block' : 'none'">
                            <option value="KTP">KTP</option>
                            <option value="Kartu Keluarga">Kartu Keluarga</option>
                            <option value="BPJS">BPJS</option>
                            <option value="NPWP">NPWP</option>
                            <option value="Karpeg">Karpeg</option>
                            <option value="Taspen">Taspen</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                    </div>
                    <div id="div-other" class="swal-form-group" style="display:none;">
                        <label class="swal-form-label">Tulis Jenis Kartu</label>
                        <input id="f-1-other" class="form-control" placeholder="Nama Kartu...">
                    </div>
                    <div class="swal-form-group"><label class="swal-form-label">Nomor Kartu</label><input id="f-2" class="form-control"></div>
                    <div class="swal-form-group"><label class="swal-form-label">Foto Kartu</label><input type="file" id="f-f" class="form-control"></div>`;
            }

            const { value: formValues } = await Swal.fire({
                title: 'Tambah Data', html: htmlForm, showCancelButton: true, confirmButtonText: 'Simpan', customClass: { popup: 'swal-wide-mobile' },
                preConfirm: async () => {
                    if (!htmlForm) return null;
                    let fileUrl = ''; const fileInput = document.getElementById('f-f');
                    if (fileInput && fileInput.files[0]) {
                        const base64 = await toBase64(fileInput.files[0]);
                        const upRes = await fetchGAS({ action: 'upload_file', base64: base64.split(',')[1], mimeType: fileInput.files[0].type, nik: currentUser.nik, type: 'DOC' });
                        if (upRes.status === 'success') fileUrl = upRes.url;
                    }
                    if (tn === 'tb_pangkat') return { Golongan: document.getElementById('f-1').value, Pangkat: document.getElementById('f-2').value, No_SK: document.getElementById('f-3').value, Tgl_SK: document.getElementById('f-4').value, TMT: document.getElementById('f-5').value, Link_File: fileUrl };
                    else if (tn === 'tb_keluarga') return { Nama: document.getElementById('f-1').value, NIK_Anggota: document.getElementById('f-2').value, Hubungan: document.getElementById('f-3').value, JK: document.getElementById('f-4').value, Tgl_Lahir: document.getElementById('f-5').value, Tunjangan: document.getElementById('f-6').value };
                    else if (tn === 'tb_jabatan') return { Nama_Jabatan: document.getElementById('f-1').value, Jenis_Jabatan: document.getElementById('f-2').value, Eselon: document.getElementById('f-3').value, Unit_Kerja: document.getElementById('f-4').value, No_SK: document.getElementById('f-5').value, TMT: document.getElementById('f-6').value, Link_File: fileUrl };
                    else if (tn === 'tb_kartu') {
                         let jenis = document.getElementById('f-1').value;
                         if(jenis === 'Lainnya') jenis = document.getElementById('f-1-other').value;
                         return { Jenis_Kartu: jenis, No_Kartu: document.getElementById('f-2').value, Link_File: fileUrl };
                    }
                    return {};
                }
            });
            if (formValues) saveData(tn, formValues);
        }

        async function saveData(t,v,id=null,tk=null) { toggleLoading(true); const n=tk||currentUser.nik; const ia=currentUser.role==='ADMIN'; const p={action:'save_data',table:t,values:v,nik:n,isAdmin:ia}; if(id)p.values.ID=id; const r=await fetchGAS(p); if(r.status==='success'){ if(!tk||tk===currentUser.nik){const ref=await fetchGAS({action:'get_data',nik:currentUser.nik});if(ref.status==='success')appData=ref.data;} toggleLoading(false); Swal.fire('Sukses','Tersimpan','success').then(()=>{ if(tk&&ia)loadAdminMaster(); else if(t==='tb_profil')navTo('profil'); else navTo(t.split('_')[1]); }); }else{toggleLoading(false);Swal.fire('Error',r.message,'error')} }
        function deleteData(t,id) { Swal.fire({title:'Hapus?',icon:'warning',showCancelButton:true,confirmButtonText:'Ya'}).then(async(r)=>{if(r.isConfirmed){toggleLoading(true); await fetchGAS({action:'delete_data',table:t,id:id}); const ref=await fetchGAS({action:'get_data',nik:currentUser.nik}); appData=ref.data; toggleLoading(false); Swal.fire('Dihapus','','success'); document.querySelector('.nav-link.active').click(); }}); }
        async function fetchGAS(p) { const r=await fetch(GAS_URL,{method:'POST',body:JSON.stringify(p)}); return await r.json(); }

        // --- ADMIN ---
        function renderAdminDashboardV2(c) { 
            c.innerHTML=`
            <div class="card p-4">
                <h4 class="fw-bold mb-3 text-primary">Admin Dashboard</h4>
                <ul class="nav nav-tabs mb-3">
                    <li class="nav-item"><button class="nav-link active" onclick="switchAT('antrean')">Antrean</button></li>
                    <li class="nav-item"><button class="nav-link" onclick="switchAT('master')">Master Pegawai</button></li>
                    <li class="nav-item"><button class="nav-link" onclick="switchAT('users')">Manajemen User</button></li>
                    <li class="nav-item"><button class="nav-link" onclick="switchAT('arsip')">Arsip Data</button></li>
                </ul>
                <div id="ac"></div>
            </div>`; 
            switchAT('antrean'); 
        }
        
        function switchAT(t) { 
            document.querySelectorAll('.nav-tabs button').forEach(b=>{b.classList.remove('active');if(b.innerText.toLowerCase().includes(t.includes('users')?'user':t))b.classList.add('active')}); 
            if(t==='antrean') loadAA(); 
            else if(t==='master') loadAM(); 
            else if(t==='users') loadAU(); // New: Load Users
            else loadAAr(); 
        }
        
        async function loadAA() { const c=document.getElementById('ac'); c.innerHTML='<div class="spinner-border text-primary"></div>'; const r=await fetchGAS({action:'admin_get_pending'}); if(r.status==='success'){adminData=r.data; renderAAT(c);}else c.innerHTML='Error'; }
        function renderAAT(c) { let h=''; const ts=[{id:'tb_profil',l:'Profil'},{id:'tb_pangkat',l:'Pangkat'},{id:'tb_jabatan',l:'Jabatan'},{id:'tb_keluarga',l:'Keluarga'},{id:'tb_kartu',l:'Kartu'}]; let hd=false; ts.forEach(t=>{const l=adminData[t.id]||[]; if(l.length>0){hd=true; let r=l.map(i=>`<tr><td><input type="checkbox" class="cb-${t.id}" value="${i.ID||i.NIK}" onchange="upVB('${t.id}')"></td><td><b>${i.Nama||'-'}</b><br>${i.NIK||i.NIK_Pegawai}</td><td><small>${JSON.stringify(i).slice(0,50)}...</small></td></tr>`).join(''); h+=`<div class="card mb-3"><div class="card-header d-flex justify-content-between"><b>${t.l}</b><button class="btn btn-sm btn-success" id="btn-v-${t.id}" onclick="exBV('${t.id}')" disabled>Verif</button></div><table class="table table-sm mb-0"><tbody>${r}</tbody></table></div>`}}); c.innerHTML=hd?h:'<div class="text-center p-4">Tidak ada antrean.</div>'; }
        
        // [UPDATED] FUNCTION LOAD ADMIN MASTER (PAGINATION)
        async function loadAM(page = 1) { 
            const c=document.getElementById('ac'); 
            const searchValue = document.getElementById('sm') ? document.getElementById('sm').value : '';
            
            // Only show loader if initial load or page change (not typing)
            if(!document.getElementById('tb-m')) c.innerHTML='<div class="spinner-border text-primary"></div>'; 
            else {
                // small visual indicator for searching
                 const tbm = document.getElementById('tb-m');
                 if(tbm) tbm.style.opacity = '0.5';
            }

            const r=await fetchGAS({action:'admin_get_table', table:'tb_profil', page: page, limit: 10, search: searchValue}); 
            
            if(r.status==='success'){ 
                const rw=r.data.map((p,i)=>`<tr><td>${((r.pagination.currentPage-1)*r.pagination.itemsPerPage) + (i+1)}</td><td><img src="${getImgUrl(p.Foto_Profil)}" class="rounded-circle me-2" width="40"><b>${p.Nama}</b><br>${p.NIP||p.NIK}</td><td>${p.Pendidikan||'-'}</td><td>${p.Jabatan_Terakhir||'-'}</td><td><span class="badge bg-${p.Status_Verifikasi==='VERIFIED'?'success':'warning'}">${p.Status_Verifikasi}</span></td><td><button onclick="showDetailUser('${p.NIK}')" class="btn btn-sm btn-info text-white me-1"><i class="fas fa-eye"></i></button> <button onclick="showFullEditUser('${p.NIK}')" class="btn btn-sm btn-warning text-dark"><i class="fas fa-pencil-alt"></i></button></td></tr>`).join(''); 
                
                // Pagination Controls
                const totalP = r.pagination.totalPages;
                const currP = r.pagination.currentPage;
                let pagHTML = `<nav><ul class="pagination justify-content-center mt-3">`;
                
                // Prev
                pagHTML += `<li class="page-item ${currP === 1 ? 'disabled' : ''}"><button class="page-link" onclick="loadAM(${currP - 1})">Prev</button></li>`;
                
                // Info Text
                pagHTML += `<li class="page-item disabled"><span class="page-link text-dark border-0">Hal ${currP} dari ${totalP} (Total: ${r.pagination.totalItems})</span></li>`;
                
                // Next
                pagHTML += `<li class="page-item ${currP === totalP ? 'disabled' : ''}"><button class="page-link" onclick="loadAM(${currP + 1})">Next</button></li>`;
                pagHTML += `</ul></nav>`;

                c.innerHTML=`<div class="mb-2"><input id="sm" class="form-control w-100" placeholder="Cari Nama/NIP..." value="${searchValue}" onkeyup="searchMasterDebounce(this)"></div><div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>No</th><th>Nama/NIP</th><th>Jabatan</th><th>Sts</th><th>Aksi</th></tr></thead><tbody id="tb-m">${rw}</tbody></table></div>${pagHTML}`; 
            } else {
                c.innerHTML = '<div class="alert alert-danger">Gagal memuat data.</div>';
            }
        }
        
        function searchMasterDebounce(el) {
            clearTimeout(adminSearchTimer);
            adminSearchTimer = setTimeout(() => {
                loadAM(1); // Reset to page 1 on search
            }, 600); // 600ms delay
        }

        // [NEW] LOAD ADMIN USERS (MANAJEMEN USER)
        async function loadAU(page = 1) {
            const c=document.getElementById('ac');
            c.innerHTML='<div class="spinner-border text-primary"></div>';
            
            // Reusing admin_get_table for tb_users
            const r=await fetchGAS({action:'admin_get_table', table:'tb_users', page: page, limit: 10});

            if(r.status==='success'){
                const rw=r.data.map((u,i)=>`
                    <tr>
                        <td>${((r.pagination.currentPage-1)*r.pagination.itemsPerPage) + (i+1)}</td>
                        <td><b>${u.Nama}</b><br>${u.NIK}</td>
                        <td>${u.Email}</td>
                        <td><span class="text-muted">******</span></td>
                        <td><span class="badge bg-${u.Role==='ADMIN'?'danger':'primary'}">${u.Role}</span></td>
                        <td>${u.Registered_At}</td>
                        <td>
                            <button onclick='editUserAdmin(${JSON.stringify(u)})' class="btn btn-sm btn-warning text-dark me-1" title="Edit User"><i class="fas fa-edit"></i></button>
                            <button onclick="resetPassAdmin('${u.NIK}', '${u.Nama}')" class="btn btn-sm btn-dark" title="Reset Password"><i class="fas fa-key"></i></button>
                        </td>
                    </tr>
                `).join('');
                
                // Pagination
                const totalP = r.pagination.totalPages;
                const currP = r.pagination.currentPage;
                let pagHTML = `<nav><ul class="pagination justify-content-center mt-3">`;
                pagHTML += `<li class="page-item ${currP === 1 ? 'disabled' : ''}"><button class="page-link" onclick="loadAU(${currP - 1})">Prev</button></li>`;
                pagHTML += `<li class="page-item disabled"><span class="page-link text-dark border-0">Hal ${currP} dari ${totalP}</span></li>`;
                pagHTML += `<li class="page-item ${currP === totalP ? 'disabled' : ''}"><button class="page-link" onclick="loadAU(${currP + 1})">Next</button></li>`;
                pagHTML += `</ul></nav>`;

                c.innerHTML=`
                    <div class="alert alert-info py-2 small"><i class="fas fa-info-circle"></i> Password hanya ditampilkan sebagai (******) untuk keamanan. Gunakan tombol kunci untuk mereset.</div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light"><tr><th>No</th><th>Nama/NIK</th><th>Email</th><th>Password</th><th>Role</th><th>Reg Date</th><th>Aksi</th></tr></thead>
                            <tbody>${rw}</tbody>
                        </table>
                    </div>${pagHTML}`;
            } else {
                c.innerHTML = '<div class="alert alert-danger">Gagal memuat data user.</div>';
            }
        }

        async function editUserAdmin(u) {
            const {value:v} = await Swal.fire({
                title: 'Edit User',
                html: `
                    <div class="swal-form-group"><label class="swal-form-label">Nama</label><input id="eu-nama" class="form-control" value="${u.Nama}"></div>
                    <div class="swal-form-group"><label class="swal-form-label">Email</label><input id="eu-email" class="form-control" value="${u.Email}"></div>
                    <div class="swal-form-group"><label class="swal-form-label">Role</label><select id="eu-role" class="form-select"><option value="USER" ${u.Role==='USER'?'selected':''}>USER</option><option value="ADMIN" ${u.Role==='ADMIN'?'selected':''}>ADMIN</option></select></div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Simpan',
                preConfirm: () => {
                    return { nik: u.NIK, nama: document.getElementById('eu-nama').value, email: document.getElementById('eu-email').value, role: document.getElementById('eu-role').value }
                }
            });

            if(v) {
                toggleLoading(true);
                const r = await fetchGAS({action: 'admin_update_user', ...v});
                toggleLoading(false);
                if(r.status === 'success') { Swal.fire('Sukses', 'Data user diupdate', 'success'); loadAU(); }
                else Swal.fire('Gagal', r.message, 'error');
            }
        }

        async function resetPassAdmin(nik, nama) {
            const {value:pass} = await Swal.fire({
                title: 'Reset Password',
                text: `Masukkan password baru untuk ${nama}`,
                input: 'text',
                inputPlaceholder: 'Password Baru...',
                showCancelButton: true,
                confirmButtonText: 'Reset',
                inputValidator: (value) => { if (!value || value.length < 6) return 'Minimal 6 karakter!' }
            });

            if(pass) {
                toggleLoading(true);
                const r = await fetchGAS({action: 'admin_reset_password', nik: nik, newPass: pass});
                toggleLoading(false);
                if(r.status === 'success') Swal.fire('Sukses', 'Password berhasil direset.', 'success');
                else Swal.fire('Gagal', r.message, 'error');
            }
        }
        
        // [NEW] FUNCTION SHOW FULL DETAIL USER
        async function showDetailUser(targetNik) {
            Swal.fire({title:'Memuat...',didOpen:()=>{Swal.showLoading()}});
            const r = await fetchGAS({action:'get_data',nik:targetNik});
            if(r.status!=='success') return Swal.fire('Error',r.message,'error');
            const d=r.data, p=d.profil||{}; const url=getImgUrl(p.Foto_Profil);
            const renderRows=(l,c)=>{if(!l||l.length==0)return'<tr><td colspan="'+(c.length+1)+'" class="text-center small">Kosong</td></tr>'; return l.map((i,x)=>`<tr><td>${x+1}</td>${c.map(k=>`<td>${i[k]||'-'}</td>`).join('')}<td>${i.Link_File?'<a href="'+i.Link_File+'" target="_blank" class="btn btn-xs btn-outline-primary"><i class="fas fa-file"></i></a>':'-'}</td></tr>`).join('')};
            const html = `
                <div class="text-center mb-4"><img src="${url}" class="rounded-circle shadow-sm border p-1" style="width:80px;height:80px;object-fit:cover"><h5 class="mt-2 mb-0 fw-bold">${p.Nama}</h5><span class="badge bg-secondary">${p.NIK}</span></div>
                <div class="text-start"><div class="row small"><div class="col-6"><b>NIP:</b> ${p.NIP||'-'}</div><div class="col-6"><b>JK:</b> ${p.JK||'-'}</div><div class="col-6"><b>Agama:</b> ${p.Agama||'-'}</div><div class="col-6"><b>HP:</b> ${p.No_HP||'-'}</div></div>
                <hr class="my-2"><h6 class="fw-bold small">Riwayat Pangkat</h6><table class="table table-sm table-bordered" style="font-size:0.75rem"><thead><tr><th>No</th><th>Gol</th><th>Pangkat</th><th>TMT</th><th>File</th></tr></thead><tbody>${renderRows(d.tb_pangkat,['Golongan','Pangkat','TMT'])}</tbody></table>
                <h6 class="fw-bold small">Riwayat Jabatan</h6><table class="table table-sm table-bordered" style="font-size:0.75rem"><thead><tr><th>No</th><th>Jabatan</th><th>Unit</th><th>TMT</th><th>File</th></tr></thead><tbody>${renderRows(d.tb_jabatan,['Nama_Jabatan','Unit_Kerja','TMT'])}</tbody></table>
                <h6 class="fw-bold small">Keluarga</h6><table class="table table-sm table-bordered" style="font-size:0.75rem"><thead><tr><th>No</th><th>Nama</th><th>Hub</th><th>JK</th><th>File</th></tr></thead><tbody>${renderRows(d.tb_keluarga,['Nama','Hubungan','JK'])}</tbody></table>
                <h6 class="fw-bold small">Kartu Identitas</h6><table class="table table-sm table-bordered" style="font-size:0.75rem"><thead><tr><th>No</th><th>Jenis</th><th>Nomor</th><th>File</th></tr></thead><tbody>${renderRows(d.tb_kartu,['Jenis_Kartu','No_Kartu'])}</tbody></table></div>`;
            Swal.fire({html:html,width:'800px',showCloseButton:true,showConfirmButton:false});
        }

        // [NEW] ADMIN FULL EDIT (Added Kartu Section)
        async function showFullEditUser(targetNik) {
            Swal.fire({title:'Memuat...',didOpen:()=>{Swal.showLoading()}});
            const r = await fetchGAS({action:'get_data',nik:targetNik});
            if(r.status!=='success') return Swal.fire('Error',r.message,'error');
            const d=r.data, p=d.profil||{};
            const renderRows=(l,c,t)=>{if(!l||l.length==0)return'<tr><td colspan="5" class="text-center">Kosong</td></tr>'; return l.map((i,x)=>`<tr><td>${x+1}</td>${c.map(k=>`<td>${i[k]||'-'}</td>`).join('')}<td><button class="btn btn-xs btn-warning p-0 px-1" onclick='editChildFromAdmin("${t}",${JSON.stringify(i)},"${targetNik}")'><i class="fas fa-pencil-alt"></i></button> <button class="btn btn-xs btn-danger p-0 px-1" onclick="deleteChildFromAdmin('${t}','${i.ID}','${targetNik}')"><i class="fas fa-trash"></i></button></td></tr>`).join('')};
            const html = `
                <div class="text-start">
                    <h6 class="fw-bold border-bottom pb-1">1. Edit Profil</h6>
                    <div class="row g-2 mb-3">
                        <div class="col-6"><label class="small fw-bold">NIP</label><input id="adm-nip" class="form-control form-control-sm" value="${p.NIP||''}"></div><div class="col-6"><label class="small fw-bold">Nama</label><input id="adm-nama" class="form-control form-control-sm" value="${p.Nama||''}"></div>
                        <div class="col-6"><label class="small fw-bold">Tempat</label><input id="adm-tmp" class="form-control form-control-sm" value="${p.Tmp_Lahir||''}"></div><div class="col-6"><label class="small fw-bold">Tgl Lahir</label><input type="date" id="adm-tgl" class="form-control form-control-sm" value="${p.Tgl_Lahir||''}"></div>
                        <div class="col-12"><label class="small fw-bold">Jabatan</label><input id="adm-jab" class="form-control form-control-sm" value="${p.Jabatan_Terakhir||''}"></div>
                        <div class="col-12"><button onclick="saveAdminProfil('${targetNik}')" class="btn btn-success btn-sm w-100">Simpan Profil</button></div>
                    </div>
                    <h6 class="fw-bold border-bottom pb-1 d-flex justify-content-between">2. Pangkat <button onclick="adminAddChild('tb_pangkat','${targetNik}')" class="btn btn-sm btn-primary py-0">+ Add</button></h6>
                    <table class="table table-sm table-bordered text-center mb-3" style="font-size:0.8rem"><thead><tr><th>No</th><th>Gol</th><th>Pangkat</th><th>TMT</th><th>Aksi</th></tr></thead><tbody>${renderRows(d.tb_pangkat,['Golongan','Pangkat','TMT'],'tb_pangkat')}</tbody></table>
                    <h6 class="fw-bold border-bottom pb-1 d-flex justify-content-between">3. Jabatan <button onclick="adminAddChild('tb_jabatan','${targetNik}')" class="btn btn-sm btn-primary py-0">+ Add</button></h6>
                    <table class="table table-sm table-bordered text-center mb-3" style="font-size:0.8rem"><thead><tr><th>No</th><th>Jabatan</th><th>Unit</th><th>TMT</th><th>Aksi</th></tr></thead><tbody>${renderRows(d.tb_jabatan,['Nama_Jabatan','Unit_Kerja','TMT'],'tb_jabatan')}</tbody></table>
                    <h6 class="fw-bold border-bottom pb-1 d-flex justify-content-between">4. Keluarga <button onclick="adminAddChild('tb_keluarga','${targetNik}')" class="btn btn-sm btn-primary py-0">+ Add</button></h6>
                    <table class="table table-sm table-bordered text-center mb-3" style="font-size:0.8rem"><thead><tr><th>No</th><th>Nama</th><th>Hub</th><th>Tunjangan</th><th>Aksi</th></tr></thead><tbody>${renderRows(d.tb_keluarga,['Nama','Hubungan','Tunjangan'],'tb_keluarga')}</tbody></table>
                    <h6 class="fw-bold border-bottom pb-1 d-flex justify-content-between">5. Kartu Identitas <button onclick="adminAddChild('tb_kartu','${targetNik}')" class="btn btn-sm btn-primary py-0">+ Add</button></h6>
                    <table class="table table-sm table-bordered text-center mb-3" style="font-size:0.8rem"><thead><tr><th>No</th><th>Jenis</th><th>Nomor</th><th>Aksi</th></tr></thead><tbody>${renderRows(d.tb_kartu,['Jenis_Kartu','No_Kartu'],'tb_kartu')}</tbody></table>
                </div>`;
            Swal.fire({ title: 'Edit Lengkap', html: html, width: '800px', showConfirmButton: false, showCloseButton: true });
        }

        async function saveAdminProfil(nik) {
            const v = { NIP: document.getElementById('adm-nip').value, Nama: document.getElementById('adm-nama').value, Tmp_Lahir: document.getElementById('adm-tmp').value, Tgl_Lahir: document.getElementById('adm-tgl').value, Jabatan_Terakhir: document.getElementById('adm-jab').value };
            await saveData('tb_profil', v, null, nik);
        }

        async function adminAddChild(t, nik) {
            let h=''; 
            if(t==='tb_pangkat') h=`<label>Golongan</label><input id="a-1" class="form-control mb-2"><label>Pangkat</label><input id="a-2" class="form-control mb-2"><label>TMT</label><input type="date" id="a-3" class="form-control">`;
            else if(t==='tb_jabatan') h=`<label>Jabatan</label><input id="a-1" class="form-control mb-2"><label>Unit</label><input id="a-2" class="form-control mb-2"><label>TMT</label><input type="date" id="a-3" class="form-control">`;
            else if(t==='tb_keluarga') h=`<label>Nama</label><input id="a-1" class="form-control mb-2"><label>Hubungan</label><select id="a-2" class="form-select"><option>Suami</option><option>Istri</option><option>Anak</option></select>`;
            else if(t==='tb_kartu') h=`<label>Jenis</label><select id="a-1" class="form-select mb-2"><option>KTP</option><option>BPJS</option><option>NPWP</option><option>Karpeg</option><option>Taspen</option></select><label>Nomor</label><input id="a-2" class="form-control">`;
            
            const {value:v} = await Swal.fire({title:'Tambah', html:h, showCancelButton:true, confirmButtonText:'Simpan'});
            if(v) { 
                let vals={}; 
                if(t==='tb_pangkat') vals={Golongan:document.getElementById('a-1').value, Pangkat:document.getElementById('a-2').value, TMT:document.getElementById('a-3').value}; 
                else if(t==='tb_jabatan') vals={Nama_Jabatan:document.getElementById('a-1').value, Unit_Kerja:document.getElementById('a-2').value, TMT:document.getElementById('a-3').value}; 
                else if(t==='tb_keluarga') vals={Nama:document.getElementById('a-1').value, Hubungan:document.getElementById('a-2').value}; 
                else if(t==='tb_kartu') {
                    let fileUrl = ''; const fileInput = document.getElementById('a-f'); // Note: Basic admin add doesn't have file input in this simplified version, would need to add it to 'h' variable above if needed
                    vals={Jenis_Kartu:document.getElementById('a-1').value, No_Kartu:document.getElementById('a-2').value, Link_File:fileUrl};
                }
                await saveData(t, vals, null, nik); showFullEditUser(nik); 
            }
        }

        async function editChildFromAdmin(t, item, nik) {
            let h=''; let vals={};
            if(t==='tb_pangkat') h=`<label>Golongan</label><input id="e-1" class="form-control mb-2" value="${item.Golongan}"><label>Pangkat</label><input id="e-2" class="form-control" value="${item.Pangkat}">`;
            else if(t==='tb_jabatan') h=`<label>Jabatan</label><input id="e-1" class="form-control mb-2" value="${item.Nama_Jabatan}"><label>Unit</label><input id="e-2" class="form-control" value="${item.Unit_Kerja}">`;
            else if(t==='tb_keluarga') h=`<label>Nama</label><input id="e-1" class="form-control" value="${item.Nama}">`;
            else if(t==='tb_kartu') h=`<label>Jenis</label><select id="e-1" class="form-select mb-2"><option value="KTP" ${item.Jenis_Kartu==='KTP'?'selected':''}>KTP</option><option value="BPJS" ${item.Jenis_Kartu==='BPJS'?'selected':''}>BPJS</option><option value="NPWP" ${item.Jenis_Kartu==='NPWP'?'selected':''}>NPWP</option></select><label>Nomor</label><input id="e-2" class="form-control" value="${item.No_Kartu}">`;

            const {value:v} = await Swal.fire({title:'Edit', html:h, showCancelButton:true, confirmButtonText:'Update'});
            if(v) { 
                 if(t==='tb_pangkat') vals={Golongan:document.getElementById('e-1').value, Pangkat:document.getElementById('e-2').value};
                 else if(t==='tb_jabatan') vals={Nama_Jabatan:document.getElementById('e-1').value, Unit_Kerja:document.getElementById('e-2').value};
                 else if(t==='tb_keluarga') vals={Nama:document.getElementById('e-1').value};
                 else if(t==='tb_kartu') vals={Jenis_Kartu:document.getElementById('e-1').value, No_Kartu:document.getElementById('e-2').value};
                 
                 await saveData(t, vals, item.ID, nik); showFullEditUser(nik); 
            }
        }

        async function deleteChildFromAdmin(t, id, nik) {
             const {isConfirmed} = await Swal.fire({title:'Hapus?',icon:'warning',showCancelButton:true});
             if(isConfirmed) { await fetchGAS({action:'delete_data',table:t,id:id}); Swal.fire('Terhapus','','success'); showFullEditUser(nik); }
        }

        function loadAAr() { document.getElementById('ac').innerHTML=`<div class="d-flex gap-2 mb-3"><select id="sat" class="form-select w-auto"><option value="tb_pangkat">Pangkat</option><option value="tb_jabatan">Jabatan</option><option value="tb_keluarga">Keluarga</option><option value="tb_kartu">Kartu</option></select><button class="btn btn-primary" onclick="fAD()">Muat</button></div><div id="adc"></div>`; fAD(); }
        async function fAD() { const t=document.getElementById('sat').value; const c=document.getElementById('adc'); c.innerHTML='Loading...'; const r=await fetchGAS({action:'admin_get_table',table:t}); if(r.status==='success'){ if(r.data.length===0){c.innerHTML='Kosong';return} const k=Object.keys(r.data[0]).filter(x=>x!=='ID'&&x!=='Link_File'); const th='<tr><th>No</th>'+k.map(x=>`<th>${x}</th>`).join('')+'<th>Aksi</th></tr>'; const tb=r.data.map((d,i)=>`<tr><td>${i+1}</td>${k.map(x=>`<td>${d[x]||'-'}</td>`).join('')}<td><button class="btn btn-sm btn-warning" onclick='editArsipItem("${t}",${JSON.stringify(d)})'><i class="fas fa-pencil-alt"></i></button> <button class="btn btn-sm btn-danger" onclick="deleteData('${t}','${d.ID}')"><i class="fas fa-trash"></i></button></td></tr>`).join(''); c.innerHTML=`<div class="table-responsive"><table class="table table-sm table-bordered table-hover mt-2"><thead class="table-dark">${th}</thead><tbody>${tb}</tbody></table></div>`; } }
        async function editArsipItem(t,d) {
            let h=''; 
            if(t==='tb_pangkat') h=`<div class="swal-form-group"><label class="swal-form-label">Golongan</label><input id="e-gol" class="form-control" value="${d.Golongan||''}"></div><div class="swal-form-group"><label class="swal-form-label">Pangkat</label><input id="e-pangkat" class="form-control" value="${d.Pangkat||''}"></div><div class="swal-form-group"><label class="swal-form-label">No SK</label><input id="e-nosk" class="form-control" value="${d.No_SK||''}"></div><div class="swal-form-group"><label class="swal-form-label">Tgl SK</label><input type="date" id="e-tglsk" class="form-control" value="${d.Tgl_SK||''}"></div><div class="swal-form-group"><label class="swal-form-label">TMT</label><input type="date" id="e-tmt" class="form-control" value="${d.TMT||''}"></div>`;
            else if(t==='tb_jabatan') h=`<div class="swal-form-group"><label class="swal-form-label">Jabatan</label><input id="e-jab" class="form-control" value="${d.Nama_Jabatan||''}"></div><div class="swal-form-group"><label class="swal-form-label">Jenis</label><select id="e-jenis" class="form-select"><option value="Struktural" ${d.Jenis_Jabatan==='Struktural'?'selected':''}>Struktural</option><option value="Fungsional" ${d.Jenis_Jabatan==='Fungsional'?'selected':''}>Fungsional</option><option value="Pelaksana" ${d.Jenis_Jabatan==='Pelaksana'?'selected':''}>Pelaksana</option></select></div><div class="swal-form-group"><label class="swal-form-label">Eselon</label><input id="e-eselon" class="form-control" value="${d.Eselon||''}"></div><div class="swal-form-group"><label class="swal-form-label">Unit</label><input id="e-unit" class="form-control" value="${d.Unit_Kerja||''}"></div><div class="swal-form-group"><label class="swal-form-label">No SK</label><input id="e-nosk" class="form-control" value="${d.No_SK||''}"></div><div class="swal-form-group"><label class="swal-form-label">TMT</label><input type="date" id="e-tmt" class="form-control" value="${d.TMT||''}"></div>`;
            else if(t==='tb_keluarga') h=`<div class="swal-form-group"><label class="swal-form-label">Nama</label><input id="e-nama" class="form-control" value="${d.Nama||''}"></div><div class="swal-form-group"><label class="swal-form-label">NIK</label><input id="e-nik" class="form-control" value="${d.NIK_Anggota||''}"></div><div class="swal-form-group"><label class="swal-form-label">Hubungan</label><select id="e-hub" class="form-select"><option value="Suami" ${d.Hubungan==='Suami'?'selected':''}>Suami</option><option value="Istri" ${d.Hubungan==='Istri'?'selected':''}>Istri</option><option value="Anak" ${d.Hubungan==='Anak'?'selected':''}>Anak</option></select></div><div class="swal-form-group"><label class="swal-form-label">JK</label><select id="e-jk" class="form-select"><option value="L" ${d.JK==='L'?'selected':''}>L</option><option value="P" ${d.JK==='P'?'selected':''}>P</option></select></div><div class="swal-form-group"><label class="swal-form-label">Tgl Lahir</label><input type="date" id="e-tgl" class="form-control" value="${d.Tgl_Lahir||''}"></div><div class="swal-form-group"><label class="swal-form-label">Tunjangan</label><select id="e-tunj" class="form-select"><option value="Ya" ${d.Tunjangan==='Ya'?'selected':''}>Ya</option><option value="Tidak" ${d.Tunjangan==='Tidak'?'selected':''}>Tidak</option></select></div>`;
            else if(t==='tb_kartu') h=`<div class="swal-form-group"><label class="swal-form-label">Jenis</label><select id="e-jenis" class="form-select"><option value="BPJS" ${d.Jenis_Kartu==='BPJS'?'selected':''}>BPJS</option><option value="NPWP" ${d.Jenis_Kartu==='NPWP'?'selected':''}>NPWP</option><option value="Karpeg" ${d.Jenis_Kartu==='Karpeg'?'selected':''}>Karpeg</option><option value="Taspen" ${d.Jenis_Kartu==='Taspen'?'selected':''}>Taspen</option></select></div><div class="swal-form-group"><label class="swal-form-label">Nomor</label><input id="e-nomor" class="form-control" value="${d.No_Kartu||''}"></div>`;
            
            const {value:v}=await Swal.fire({title:'Edit Arsip',html:h,showCancelButton:true,confirmButtonText:'Update',preConfirm:()=>{
                if(t==='tb_pangkat') return {Golongan:document.getElementById('e-gol').value, Pangkat:document.getElementById('e-pangkat').value, No_SK:document.getElementById('e-nosk').value, Tgl_SK:document.getElementById('e-tglsk').value, TMT:document.getElementById('e-tmt').value};
                if(t==='tb_jabatan') return {Nama_Jabatan:document.getElementById('e-jab').value, Jenis_Jabatan:document.getElementById('e-jenis').value, Eselon:document.getElementById('e-eselon').value, Unit_Kerja:document.getElementById('e-unit').value, No_SK:document.getElementById('e-nosk').value, TMT:document.getElementById('e-tmt').value};
                if(t==='tb_keluarga') return {Nama:document.getElementById('e-nama').value, NIK_Anggota:document.getElementById('e-nik').value, Hubungan:document.getElementById('e-hub').value, JK:document.getElementById('e-jk').value, Tgl_Lahir:document.getElementById('e-tgl').value, Tunjangan:document.getElementById('e-tunj').value};
                return {Jenis_Kartu:document.getElementById('e-jenis').value, No_Kartu:document.getElementById('e-nomor').value};
            }});
            if(v) {
                v.Link_File = d.Link_File; 
                saveData(t, v, d.ID, d.NIK||d.NIK_Pegawai);
            }
        }

        function upVB(t){const c=document.querySelectorAll(`.cb-${t}:checked`).length;document.getElementById(`btn-v-${t}`).disabled=c===0}
        async function exBV(t){const i=Array.from(document.querySelectorAll(`.cb-${t}:checked`)).map(c=>c.value);if(i.length>0){toggleLoading(true);await fetchGAS({action:'admin_bulk_verify',table:t,ids:i});toggleLoading(false);loadAA();Swal.fire('Sukses','','success')}}

        const sess=sessionStorage.getItem('simpeg_user'); if(sess){currentUser=JSON.parse(sess);initApp();}
    </script>
</body>
</html>
